# `im-infra/metrics` - 可观测性基础设施库

本库为 GoChat 分布式系统的所有微服务提供了统一的、自动化的可观测性（Observability）能力。它是保障系统线上稳定运行、快速定位问题和进行性能优化的“眼睛”和“神经系统”。

## 1. 为什么需要这个库？- 可观测性的三大支柱

想象一下，我们的 GoChat 系统是一辆正在高速行驶的复杂赛车。为了确保它能跑得又快又稳，你需要一套精密的仪表系统。本库就提供了这套系统，它主要建立在“可观测性三大支柱”之上：

### a. 指标 (Metrics) - 你的“仪表盘”

*   **是什么？** 一系列可量化的数字，告诉你系统**宏观的健康状况**。
*   **好比是？** 赛车上的**速度表、转速表、油量表**。
*   **能回答什么问题？**
    *   “`im-logic` 服务的平均请求延迟是多少？”
    *   “`im-gateway` 的 CPU 使用率高吗？”
    *   “过去一小时，消息发送的错误率是多少？”
*   **作用**：Metrics 能让你快速发现系统**“是不是”**出问题了，并是自动化告警的基础。

### b. 链路追踪 (Tracing) - 你的“GPS 导航全记录”

*   **是什么？** 记录一个请求（例如，用户A发送消息给用户B）从进入系统到最终完成的**完整旅程**。
*   **好比是？** 赛车的 GPS 系统记录下了它在赛道上每一圈、每一个弯道的精确轨迹和用时。
*   **能回答什么问题？**
    *   “一个发送消息的请求，在 `im-gateway` 耗时 10ms，在 `im-logic` 耗时 30ms，在 `im-repo` 耗时 50ms。”
    *   “为什么这次请求变慢了？哦，原来是 `im-repo` 访问数据库时出现了瓶颈。”
*   **作用**：当 Metrics 告诉你“系统慢了”，Tracing 能帮你精准定位**“慢在哪”**。

### c. 日志 (Logging) - 你的“行车记录仪”

*   **是什么？** 系统在特定代码位置、特定时间点发生的、带有丰富上下文的事件记录。
*   **好比是？** 赛车的行车记录仪，详细记录了某一刻发生的所有细节。
*   **能回答什么问题？**
    *   “`im-repo` 服务为什么慢？哦，日志显示‘数据库连接超时’。”
    *   “用户登录为什么失败？日志记录了‘密码校验错误，用户ID: 123’。”
*   **作用**：当 Tracing 告诉你“问题出在 `im-repo`”，日志能告诉你**“为什么出问题”**。

**三者结合，就让我们对系统内部发生的一切了如指掌，从而实现真正意义上的“可观测性”。**

## 2. 本库做了什么？

本库基于业界标准 **OpenTelemetry** 构建，它优雅地将上述三大支柱的能力封装起来，并提供给所有业务服务。

*   **自动化是核心**：你不需要在业务代码中手动记录每一个请求的耗时和路径。本库提供了 gRPC 和 HTTP 的“拦截器”，它们会自动为所有请求生成 Metrics 和 Traces。
*   **与技术栈解耦**：底层使用 OpenTelemetry，意味着我们可以轻松地将数据上报给任何兼容的后端系统（如 `Jaeger` 用于追踪，`Prometheus` 用于指标），而无需修改一行代码。
*   **提供统一接口**：通过 `metrics.New()` 创建一个 `Provider` 实例，你就可以获得所有你需要的能力，保持了 `im-infra` 生态的高度一致性。

## 3. 设计理念

*   **高内聚，低耦合**：将所有与可观测性相关的复杂逻辑内聚在本库的 `internal` 包中，与业务代码完全解耦。
*   **约定优于配置**：提供一套合理的默认配置，让开发者可以“开箱即用”，同时保留了通过 `Config` 结构进行深度定制的能力。
*   **面向接口编程**：对外暴露的是 `Provider` 接口，而不是具体的实现，为未来的扩展和重构提供了极大的灵活性。

要了解如何具体使用本库，请参考 `API.md` 文档。