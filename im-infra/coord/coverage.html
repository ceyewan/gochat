
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>coord: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/ceyewan/gochat/im-infra/coord/config.go (100.0%)</option>
				
				<option value="file1">github.com/ceyewan/gochat/im-infra/coord/coord.go (92.1%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">no coverage</span>
				<span class="cov1">low coverage</span>
				<span class="cov2">*</span>
				<span class="cov3">*</span>
				<span class="cov4">*</span>
				<span class="cov5">*</span>
				<span class="cov6">*</span>
				<span class="cov7">*</span>
				<span class="cov8">*</span>
				<span class="cov9">*</span>
				<span class="cov10">high coverage</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package coord

import "time"

// CoordinatorConfig 协调器配置配置
type CoordinatorConfig struct {
        // Endpoints etcd 服务器地址列表
        Endpoints []string `json:"endpoints"`

        // Username etcd 用户名（可选）
        Username string `json:"username,omitempty"`

        // Password etcd 密码（可选）
        Password string `json:"password,omitempty"`

        // Timeout 连接超时时间
        Timeout time.Duration `json:"timeout"`

        // RetryConfig 重试配置
        RetryConfig *RetryConfig `json:"retry_config,omitempty"`
}

// RetryConfig 重试机制配置
type RetryConfig struct {
        // MaxAttempts 最大重试次数
        MaxAttempts int `json:"max_attempts"`

        // InitialDelay 初始延迟
        InitialDelay time.Duration `json:"initial_delay"`

        // MaxDelay 最大延迟
        MaxDelay time.Duration `json:"max_delay"`

        // Multiplier 退避倍数
        Multiplier float64 `json:"multiplier"`
}

// DefaultConfig 返回默认配置
func DefaultConfig() CoordinatorConfig <span class="cov10" title="30">{
        return CoordinatorConfig{
                Endpoints: []string{"localhost:2379"},
                Timeout:   5 * time.Second,
                RetryConfig: &amp;RetryConfig{
                        MaxAttempts:  3,
                        InitialDelay: 100 * time.Millisecond,
                        MaxDelay:     2 * time.Second,
                        Multiplier:   2.0,
                },
        }
}</span>
</pre>
		
		<pre class="file" id="file1" style="display: none">package coord

import (
        "sync"

        "github.com/ceyewan/gochat/im-infra/clog"
        "github.com/ceyewan/gochat/im-infra/coord/config"
        "github.com/ceyewan/gochat/im-infra/coord/internal/client"
        "github.com/ceyewan/gochat/im-infra/coord/internal/configimpl"
        "github.com/ceyewan/gochat/im-infra/coord/internal/lockimpl"
        "github.com/ceyewan/gochat/im-infra/coord/internal/registryimpl"
        "github.com/ceyewan/gochat/im-infra/coord/lock"
        "github.com/ceyewan/gochat/im-infra/coord/registry"
)

// Provider 定义协调器的核心接口
type Provider interface {
        // Lock 获取分布式锁服务
        Lock() lock.DistributedLock
        // Registry 获取服务注册发现服务
        Registry() registry.ServiceRegistry
        // Config 获取配置中心服务
        Config() config.ConfigCenter
        // Close 关闭协调器并释放资源
        Close() error
}

// coordinator 主协调器实现
type coordinator struct {
        client   *client.EtcdClient
        lock     lock.DistributedLock
        registry registry.ServiceRegistry
        config   config.ConfigCenter
        logger   clog.Logger
        closed   bool
        mu       sync.RWMutex
}

// New 创建并返回一个新的协调器实例
func New(cfgs ...CoordinatorConfig) (Provider, error) <span class="cov10" title="32">{
        var cfg CoordinatorConfig
        // 1. 如果没有提供配置，使用默认配置
        if len(cfgs) == 0 </span><span class="cov0" title="0">{
                cfg = DefaultConfig()
        }</span> else<span class="cov10" title="32"> {
                cfg = cfgs[0]
        }</span>

        <span class="cov10" title="32">logger := clog.Module("coord")
        logger.Info("creating new coordinator",
                clog.Strings("endpoints", cfg.Endpoints))

        // 2. 创建内部 etcd 客户端
        clientCfg := client.Config{
                Endpoints:   cfg.Endpoints,
                Username:    cfg.Username,
                Password:    cfg.Password,
                Timeout:     cfg.Timeout,
                RetryConfig: (*client.RetryConfig)(cfg.RetryConfig),
                Logger:      logger.With(clog.String("component", "etcd-client")),
        }
        etcdClient, err := client.New(clientCfg)
        if err != nil </span><span class="cov1" title="1">{
                logger.Error("failed to create etcd client", clog.Err(err))
                return nil, err
        }</span>

        // 3. 创建内部服务
        <span class="cov9" title="31">lockService := lockimpl.NewEtcdLockFactory(etcdClient, "/locks", logger.With(clog.String("component", "lock")))
        registryService := registryimpl.NewEtcdServiceRegistry(etcdClient, "/services", logger.With(clog.String("component", "registry")))
        configService := configimpl.NewEtcdConfigCenter(etcdClient, "/config", logger.With(clog.String("component", "config")))

        // 4. 组装 coordinator
        coord := &amp;coordinator{
                client:   etcdClient,
                lock:     lockService,
                registry: registryService,
                config:   configService,
                logger:   logger,
                closed:   false,
        }

        logger.Info("coordinator created successfully")
        return coord, nil</span>
}

// Lock 实现 Provider 接口 - 获取分布式锁服务
func (c *coordinator) Lock() lock.DistributedLock <span class="cov7" title="13">{
        c.mu.RLock()
        defer c.mu.RUnlock()
        return c.lock
}</span>

// Registry 实现 Provider 接口 - 获取服务注册发现服务
func (c *coordinator) Registry() registry.ServiceRegistry <span class="cov7" title="13">{
        c.mu.RLock()
        defer c.mu.RUnlock()
        return c.registry
}</span>

// Config 实现 Provider 接口 - 获取配置中心服务
func (c *coordinator) Config() config.ConfigCenter <span class="cov7" title="14">{
        c.mu.RLock()
        defer c.mu.RUnlock()
        return c.config
}</span>

// Close 实现 Provider 接口 - 关闭协调器并释放资源
func (c *coordinator) Close() error <span class="cov10" title="32">{
        c.mu.Lock()
        defer c.mu.Unlock()

        if c.closed </span><span class="cov1" title="1">{
                return nil
        }</span>

        <span class="cov9" title="31">c.logger.Info("closing coordinator")

        // 关闭 etcd 客户端
        if c.client != nil </span><span class="cov9" title="31">{
                if err := c.client.Close(); err != nil </span><span class="cov0" title="0">{
                        c.logger.Error("failed to close etcd client", clog.Err(err))
                        return err
                }</span>
        }

        <span class="cov9" title="31">c.closed = true
        c.logger.Info("coordinator closed successfully")
        return nil</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
