# etcd-grpc æœåŠ¡æ³¨å†Œä¸å‘ç°ç»„ä»¶

etcd-grpc æ˜¯ä¸€ä¸ªåŸºäº etcd æ„å»ºçš„ä¼ä¸šçº§æœåŠ¡æ³¨å†Œä¸å‘ç°ç»„ä»¶ï¼Œä¸“ä¸º gRPC å¾®æœåŠ¡æ¶æ„è®¾è®¡ã€‚å®ƒæä¾›äº†å®Œæ•´çš„åˆ†å¸ƒå¼æœåŠ¡ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬æœåŠ¡æ³¨å†Œå‘ç°ã€åˆ†å¸ƒå¼é”ã€ç§Ÿçº¦ç®¡ç†ç­‰æ ¸å¿ƒç‰¹æ€§ã€‚

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

- **æœåŠ¡æ³¨å†Œä¸å‘ç°** - è‡ªåŠ¨æœåŠ¡æ³¨å†Œã€å®æ—¶æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡
- **åˆ†å¸ƒå¼é”** - åŸºäº etcd çš„å¯é åˆ†å¸ƒå¼é”å®ç°
- **ç§Ÿçº¦ç®¡ç†** - ç»Ÿä¸€çš„ç§Ÿçº¦ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œè‡ªåŠ¨ç»­çº¦
- **è¿æ¥ç®¡ç†** - è¿æ¥æ± ã€å¥åº·æ£€æŸ¥ã€è‡ªåŠ¨é‡è¿
- **é…ç½®ç®¡ç†** - çµæ´»çš„é…ç½®é€‰é¡¹å’Œå»ºé€ è€…æ¨¡å¼
- **é”™è¯¯å¤„ç†** - ç»“æ„åŒ–é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   EtcdManager   â”‚â”€â”€â”€â”€â”‚ ServiceRegistry â”‚    â”‚ ServiceDiscoveryâ”‚
â”‚   (ç»Ÿä¸€ç®¡ç†)     â”‚    â”‚   (æœåŠ¡æ³¨å†Œ)     â”‚    â”‚   (æœåŠ¡å‘ç°)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚                 â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DistributedLock â”‚ â”‚  LeaseManager   â”‚ â”‚ConnectionManagerâ”‚ â”‚   gRPC Resolver â”‚
â”‚   (åˆ†å¸ƒå¼é”)     â”‚ â”‚   (ç§Ÿçº¦ç®¡ç†)      â”‚ â”‚   (è¿æ¥ç®¡ç†)     â”‚ â”‚   (è§£æå™¨é›†æˆ)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ï¿½ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ä½¿ç”¨

```go
package main

import (
    "context"
    "log"
    "time"

    "github.com/your-org/etcd-grpc/etcd"
)

func main() {
    // å¿«é€Ÿå¯åŠ¨ - è‡ªåŠ¨ä½¿ç”¨é…ç½®æ–‡ä»¶æˆ–é»˜è®¤é…ç½®
    manager, err := etcd.QuickStart()
    if err != nil {
        log.Fatalf("Failed to start: %v", err)
    }
    defer manager.Close()

    ctx := context.Background()

    // æœåŠ¡æ³¨å†Œ
    registry := manager.ServiceRegistry()
    err = registry.Register(ctx, "user-service", "instance-1", "localhost:50051")
    if err != nil {
        log.Fatalf("Failed to register: %v", err)
    }

    // æœåŠ¡å‘ç°
    discovery := manager.ServiceDiscovery()
    conn, err := discovery.GetConnection(ctx, "user-service")
    if err != nil {
        log.Fatalf("Failed to discover: %v", err)
    }
    defer conn.Close()

    // åˆ†å¸ƒå¼é”
    lock := manager.DistributedLock()
    err = lock.Lock(ctx, "my-lock", 30*time.Second)
    if err != nil {
        log.Fatalf("Failed to acquire lock: %v", err)
    }
    defer lock.Unlock(ctx, "my-lock")
}
```

### é«˜çº§é…ç½®

```go
// ä½¿ç”¨å»ºé€ è€…æ¨¡å¼åˆ›å»ºè‡ªå®šä¹‰é…ç½®
manager, err := etcd.NewManagerBuilder().
    WithEndpoints([]string{"etcd1:2379", "etcd2:2379", "etcd3:2379"}).
    WithDialTimeout(10 * time.Second).
    WithDefaultTTL(60).
    WithServicePrefix("/prod/services").
    WithLockPrefix("/prod/locks").
    WithHealthCheck(30*time.Second, 5*time.Second).
    WithRetryConfig(&etcd.RetryConfig{
        MaxRetries:      5,
        InitialInterval: 200 * time.Millisecond,
        MaxInterval:     5 * time.Second,
        Multiplier:      2.0,
    }).
    Build()
```

## âš™ï¸ é…ç½®ç®¡ç†

### é…ç½®ä¼˜å…ˆçº§

etcd-grpc æ”¯æŒçµæ´»çš„é…ç½®ç®¡ç†ï¼ŒæŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§é¡ºåºåŠ è½½é…ç½®ï¼š

1. **ç”¨æˆ·è¾“å…¥å‚æ•°** (æœ€é«˜ä¼˜å…ˆçº§)
2. **é…ç½®æ–‡ä»¶**
3. **é»˜è®¤å€¼** (æœ€ä½ä¼˜å…ˆçº§)

### é…ç½®æ–‡ä»¶ç¤ºä¾‹

#### JSON æ ¼å¼ (etcd-config.json)

```json
{
  "endpoints": ["localhost:23791", "localhost:23792", "localhost:23793"],
  "dial_timeout": "5s",
  "log_level": "info"
}
```

#### YAML æ ¼å¼ (etcd-config.yaml)

```yaml
endpoints:
  - localhost:23791
  - localhost:23792
  - localhost:23793
dial_timeout: 5s
log_level: info
```

### é…ç½®æ–‡ä»¶ä½ç½®

ç³»ç»Ÿä¼šè‡ªåŠ¨æŸ¥æ‰¾ä»¥ä¸‹é…ç½®æ–‡ä»¶ï¼ˆæŒ‰ä¼˜å…ˆçº§é¡ºåºï¼‰ï¼š

- `etcd-config.json`
- `etcd-config.yaml`
- `etcd-config.yml`
- `config/etcd.json`
- `config/etcd.yaml`
- `config/etcd.yml`

### ä½¿ç”¨ç¤ºä¾‹

```go
// æ–¹å¼1: è‡ªåŠ¨é…ç½® - ä¼˜å…ˆä½¿ç”¨é…ç½®æ–‡ä»¶ï¼Œå›é€€åˆ°é»˜è®¤å€¼
manager, err := etcd.QuickStart()

// æ–¹å¼2: æŒ‡å®šç«¯ç‚¹ - ç”¨æˆ·è¾“å…¥è¦†ç›–é…ç½®æ–‡ä»¶
manager, err := etcd.QuickStart("custom:2379")

// æ–¹å¼3: æŒ‡å®šé…ç½®æ–‡ä»¶
config, err := etcd.LoadConfigFromFile("custom-config.json")
if err != nil {
    log.Fatal(err)
}
manager, err := etcd.NewManagerWithConfig(config)
```

## âš™ï¸ é…ç½®é€‰é¡¹

### è¿æ¥é…ç½®
- `WithEndpoints([]string)` - etcd æœåŠ¡å™¨åœ°å€åˆ—è¡¨
- `WithDialTimeout(time.Duration)` - è¿æ¥è¶…æ—¶æ—¶é—´
- `WithAuth(username, password)` - è®¤è¯ä¿¡æ¯
- `WithTLS(*TLSConfig)` - TLS å®‰å…¨é…ç½®

### æœåŠ¡é…ç½®
- `WithDefaultTTL(int64)` - é»˜è®¤æœåŠ¡ TTLï¼ˆç§’ï¼‰
- `WithServicePrefix(string)` - æœåŠ¡æ³¨å†Œå‰ç¼€
- `WithLockPrefix(string)` - åˆ†å¸ƒå¼é”å‰ç¼€
- `WithDefaultMetadata(map[string]string)` - é»˜è®¤å…ƒæ•°æ®

### å¯é æ€§é…ç½®
- `WithHealthCheck(interval, timeout)` - å¥åº·æ£€æŸ¥é…ç½®
- `WithRetryConfig(*RetryConfig)` - é‡è¯•ç­–ç•¥é…ç½®
- `WithConnectionPool(maxIdle, maxActive, maxLifetime)` - è¿æ¥æ± é…ç½®

### é¢„è®¾ç¯å¢ƒé…ç½®

```go
// å¼€å‘ç¯å¢ƒ
manager, err := etcd.NewDevelopmentManager()

// ç”Ÿäº§ç¯å¢ƒ
manager, err := etcd.NewProductionManager([]string{
    "etcd1.prod.com:2379",
    "etcd2.prod.com:2379",
    "etcd3.prod.com:2379",
})

// æµ‹è¯•ç¯å¢ƒ
manager, err := etcd.NewTestManager()
```

## ğŸ”§ åŠŸèƒ½ç‰¹æ€§

### æœåŠ¡æ³¨å†Œä¸å‘ç°
- è‡ªåŠ¨æœåŠ¡æ³¨å†Œå’Œæ³¨é”€
- æ”¯æŒæœåŠ¡å…ƒæ•°æ®
- å®æ—¶æœåŠ¡å‘ç°
- gRPC è´Ÿè½½å‡è¡¡é›†æˆ
- æœåŠ¡å˜åŒ–ç›‘å¬

### åˆ†å¸ƒå¼é”
- é˜»å¡å’Œéé˜»å¡é”è·å–
- è‡ªåŠ¨é”ç»­çº¦
- é”çŠ¶æ€æŸ¥è¯¢
- è¶…æ—¶å¤„ç†

### ç§Ÿçº¦ç®¡ç†
- ç§Ÿçº¦åˆ›å»ºå’Œæ’¤é”€
- è‡ªåŠ¨ç»­çº¦æœºåˆ¶
- ç§Ÿçº¦çŠ¶æ€ç›‘æ§
- è¿‡æœŸæ¸…ç†

### è¿æ¥ç®¡ç†
- è¿æ¥æ± ç®¡ç†
- å¥åº·æ£€æŸ¥
- è‡ªåŠ¨é‡è¿
- TLS æ”¯æŒ

## ğŸ“‹ æœ€ä½³å®è·µ

### é…ç½®ç®¡ç†
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶ç®¡ç†ç«¯ç‚¹ï¼Œé¿å…ç¡¬ç¼–ç 
- **å¼€å‘ç¯å¢ƒ**ï¼šåˆ›å»º `etcd-config.json` æŒ‡å‘æœ¬åœ° etcd é›†ç¾¤
- **æµ‹è¯•ç¯å¢ƒ**ï¼šä½¿ç”¨ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶å’ŒæœåŠ¡å‰ç¼€
- **é…ç½®éªŒè¯**ï¼šåœ¨éƒ¨ç½²å‰éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼å’Œç«¯ç‚¹å¯è¾¾æ€§

### ç”Ÿäº§ç¯å¢ƒ
- ä½¿ç”¨ etcd é›†ç¾¤ç¡®ä¿é«˜å¯ç”¨æ€§
- é…ç½®é€‚å½“çš„è¶…æ—¶å’Œé‡è¯•ç­–ç•¥
- ç›‘æ§æœåŠ¡æ³¨å†ŒçŠ¶æ€å’Œè¿æ¥å¥åº·
- åˆç†è®¾ç½®è¿æ¥æ± å¤§å°å’Œç§Ÿçº¦ TTL
- ä½¿ç”¨é…ç½®æ–‡ä»¶è€Œéç¡¬ç¼–ç ç«¯ç‚¹

### å¼€å‘æµ‹è¯•
- ä½¿ç”¨ä¸åŒçš„æœåŠ¡å‰ç¼€åŒºåˆ†ç¯å¢ƒ
- ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- ä½¿ç”¨é¢„è®¾ç¯å¢ƒé…ç½®
- åˆ›å»ºç¯å¢ƒç‰¹å®šçš„é…ç½®æ–‡ä»¶

### é”™è¯¯å¤„ç†
- å®ç°ä¼˜é›…é™çº§æœºåˆ¶
- ä½¿ç”¨æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥
- è®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- æ£€æŸ¥é…ç½®é”™è¯¯å’Œè¿æ¥é”™è¯¯

### æ•…éšœæ’é™¤

#### å¸¸è§é—®é¢˜

1. **è¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥ etcd æœåŠ¡çŠ¶æ€
   docker ps | grep etcd
   
   # æ£€æŸ¥ç«¯å£æ˜¯å¦å¯è¾¾
   telnet localhost 23791
   ```

2. **é…ç½®æ–‡ä»¶æœªç”Ÿæ•ˆ**
   ```bash
   # ç¡®è®¤é…ç½®æ–‡ä»¶ä½ç½®
   ls -la etcd-config.json
   
   # éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼
   cat etcd-config.json | jq .
   ```

3. **é»˜è®¤ç«¯ç‚¹é—®é¢˜**
   ```go
   // æ˜¾å¼æŒ‡å®šç«¯ç‚¹
   manager, err := etcd.QuickStart("localhost:2379")
   ```

## ğŸ“š æ–‡æ¡£

- [API æ–‡æ¡£](API.md) - å®Œæ•´çš„ API å‚è€ƒ
- [ç¤ºä¾‹ä»£ç ](main.go) - è¯¦ç»†çš„ä½¿ç”¨ç¤ºä¾‹
- [æµ‹è¯•ç”¨ä¾‹](test/) - å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ã€‚

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚