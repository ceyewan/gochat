# Mock后端修复测试指南

## 修复内容概述

本次修复了Mock后端的以下问题：
1. **用户名显示问题** - 消息发送者显示错误的用户名
2. **在线状态问题** - 无法正确显示和更新用户在线状态

## 测试环境准备

### 1. 启动Mock服务器
```bash
cd mock-server
npm start
```

### 2. 启动前端项目
```bash
cd gochat-frontend
npm run dev
```

### 3. 准备多个浏览器标签页
为了测试在线状态和消息显示，需要：
- 标签页1：登录张三
- 标签页2：登录李四
- 标签页3：登录王五（可选）

## 测试用例

### 测试1: 用户名显示修复验证

**目标**: 验证消息发送者显示正确的用户名

**步骤**:
1. **标签页1**: 使用"张三"登录
2. **标签页2**: 使用"李四"登录
3. **标签页1**: 在技术交流群中发送消息："大家好，我是张三"
4. **标签页2**: 查看技术交流群中的消息

**预期结果**:
- [ ] 在标签页2中看到的消息发送者显示为"张三"
- [ ] 不再显示"测试用户1"或其他错误的用户名
- [ ] 消息内容正确显示

**单聊测试**:
1. **标签页1**: 张三向李四发送消息："你好李四，我是张三"
2. **标签页2**: 李四查看与张三的单聊

**预期结果**:
- [ ] 李四看到的消息发送者显示为"张三"
- [ ] 消息显示在正确的会话中

### 测试2: 在线状态显示修复验证

**目标**: 验证用户在线状态正确显示和更新

**步骤**:
1. **标签页1**: 张三登录后查看好友列表
2. **标签页2**: 李四登录
3. **标签页1**: 观察李四的在线状态变化
4. **标签页2**: 关闭浏览器标签页或刷新页面
5. **标签页1**: 观察李四的在线状态变化

**预期结果**:
- [ ] 张三登录后能看到其他已在线用户的状态
- [ ] 李四登录后，张三能看到李四变为在线状态
- [ ] 李四离线后，张三能看到李四变为离线状态
- [ ] 在线状态更新及时（1-2秒内）

**会话中的在线状态**:
1. **标签页1**: 张三点击与李四的单聊
2. 观察聊天头部的在线状态显示

**预期结果**:
- [ ] 如果李四在线，显示"在线"
- [ ] 如果李四离线，显示"离线"
- [ ] 状态与实际情况一致

### 测试3: 群聊中的用户名和在线状态

**目标**: 验证群聊中的用户名显示和在线状态

**步骤**:
1. **标签页1**: 张三进入技术交流群
2. **标签页2**: 李四进入技术交流群
3. **标签页3**: 王五登录并进入技术交流群
4. 三人轮流发送消息

**预期结果**:
- [ ] 每个人发送的消息都显示正确的用户名
- [ ] 群聊头部显示正确的成员数量
- [ ] 可以看到其他成员的在线状态（如果有相关UI）

### 测试4: WebSocket连接状态测试

**目标**: 验证WebSocket连接和状态广播

**步骤**:
1. 打开浏览器开发者工具的控制台
2. **标签页1**: 张三登录，观察控制台日志
3. **标签页2**: 李四登录，观察两个标签页的控制台日志
4. 发送消息，观察WebSocket消息

**预期结果**:
- [ ] 控制台显示"WebSocket连接成功"
- [ ] 用户上线时广播在线状态消息
- [ ] 消息发送时显示正确的用户信息
- [ ] 没有错误日志

### 测试5: 多用户实时通信测试

**目标**: 验证多用户间的实时通信

**步骤**:
1. **标签页1**: 张三登录
2. **标签页2**: 李四登录
3. **标签页1**: 张三发送消息给李四："你好李四"
4. **标签页2**: 李四回复："你好张三"
5. 观察消息的实时性和用户名显示

**预期结果**:
- [ ] 消息实时到达（1-2秒内）
- [ ] 发送者用户名正确显示
- [ ] 消息状态正确更新（发送中 → 已发送）
- [ ] 在线状态实时更新

## 调试信息

### 控制台日志检查
在浏览器控制台中应该看到：
```
WebSocket连接成功
WebSocket连接确认: {message: "WebSocket连接成功"}
在线状态初始化完成
广播用户 user1 上线 状态
收到WebSocket消息: {type: "friend-online", data: {userId: "user2", online: true}}
```

### 网络面板检查
在开发者工具的网络面板中检查：
- [ ] WebSocket连接建立成功
- [ ] API请求正常响应
- [ ] 在线状态API返回正确数据

## 问题排查

### 如果用户名仍然显示错误
1. 检查Mock服务器是否重启
2. 查看服务器控制台是否有错误
3. 确认用户登录时使用的是正确的用户名

### 如果在线状态不更新
1. 检查WebSocket连接是否正常
2. 查看控制台是否有WebSocket错误
3. 确认多个标签页使用不同的用户登录

### 如果消息发送失败
1. 检查WebSocket连接状态
2. 查看控制台错误信息
3. 确认Mock服务器正常运行

## 验证清单

- [ ] 消息发送者显示正确的用户名
- [ ] 在线状态正确显示和更新
- [ ] WebSocket连接稳定
- [ ] 多用户实时通信正常
- [ ] 群聊功能正常
- [ ] 单聊功能正常
- [ ] 控制台无错误日志
- [ ] 网络请求正常

## 总结

通过以上测试，可以验证：
1. **用户名显示问题已解决** - 消息发送者显示真实用户名而不是硬编码的测试用户名
2. **在线状态功能正常** - 用户上线/离线状态能够正确显示和实时更新
3. **WebSocket通信稳定** - 消息发送、状态更新等实时功能正常工作

这些修复提升了Mock后端的真实性和用户体验，使得测试环境更接近真实的聊天应用。
