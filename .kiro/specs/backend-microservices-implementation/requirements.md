# 需求文档

## 介绍

本文档定义了实现 GoChat 后端微服务系统的需求。GoChat 是一个基于 Go 构建的分布式即时通讯系统，采用微服务架构，包含四个核心服务：im-gateway、im-logic、im-task 和 im-repo，以及一个共享基础设施库 (im-infra)。系统支持实时消息传递、用户认证和跨不同会话类型的可扩展消息分发。

该实现将提供支持现有 Vue.js 前端应用所需的后端服务，使用户能够注册、认证、发送消息并参与各种类型的会话（单聊、群聊和世界聊天）。

## 需求

### 需求 1: 基础设施库 (im-infra)

**用户故事:** 作为后端开发者，我希望有一个共享的基础设施库，提供通用工具和标准化接口，以便所有微服务都能使用一致的数据库访问、缓存、消息队列、日志记录和配置管理实现。

#### 验收标准

1. 当服务需要数据库连接时，im-infra 应提供支持 MySQL 读写分离的统一数据库管理器
2. 当服务需要缓存功能时，im-infra 应提供带有连接池和错误处理的 Redis 客户端包装器
3. 当服务需要消息队列操作时，im-infra 应提供带有自动序列化的 Kafka 生产者和消费者抽象
4. 当服务需要分布式 ID 生成时，im-infra 应提供基于 Snowflake 的 ID 生成器，使用 etcd 管理机器 ID
5. 当服务需要日志记录时，im-infra 应提供使用 zap 的结构化日志，包含 trace ID 和服务上下文
6. 当服务需要配置管理时，im-infra 应提供支持多种来源（文件、环境变量、etcd）的配置加载器
7. 当服务需要服务发现时，im-infra 应提供用于服务注册和发现的 etcd 客户端工具
8. 当服务需要分布式追踪时，im-infra 应提供带有自动 span 创建的 OpenTelemetry 集成

### 需求 2: 数据仓储服务 (im-repo)

**用户故事:** 作为系统架构师，我希望有一个统一的数据访问层来处理所有数据库和缓存操作，以便其他服务可以通过定义良好的 gRPC 接口访问数据，而无需直接管理数据库连接或缓存逻辑。

#### 验收标准

1. 当 im-logic 请求用户数据时，im-repo 应提供带有 bcrypt 密码哈希的用户 CRUD 操作 gRPC 方法
2. 当 im-logic 请求消息存储时，im-repo 应原子性地将消息保存到 MySQL 并更新 Redis 热消息缓存
3. 当 im-logic 请求消息历史时，im-repo 应从 MySQL 检索消息，支持分页并缓存频繁访问的数据
4. 当 im-logic 请求群组信息时，im-repo 应提供包括成员操作在内的群组管理 gRPC 方法
5. 当任何服务请求缓存数据时，im-repo 应实现 Cache-Aside 模式，自动回退到数据库
6. 当写入数据时，im-repo 应使用 Write-Through 缓存策略来维护一致性
7. 当数据库操作失败时，im-repo 应返回适当的 gRPC 错误代码和详细错误消息
8. 当缓存操作失败时，im-repo 应继续数据库操作并记录警告，不使请求失败

### 需求 3: 业务逻辑服务 (im-logic)

**用户故事:** 作为产品负责人，我希望有一个处理消息传递和用户管理所有核心业务逻辑的服务，以便系统能够根据业务规则处理消息、管理会话和协调消息分发。

#### 验收标准

1. 当用户注册时，im-logic 应验证用户数据，生成唯一用户 ID，并通过 im-repo 存储用户信息
2. 当用户登录时，im-logic 应验证凭据并返回包含用户信息的 JWT 令牌
3. 当从 Kafka 接收到消息时，im-logic 应验证、生成消息 ID 和序列号，并通过 im-repo 持久化
4. 当消息需要分发时，im-logic 应根据会话类型确定接收者并路由到适当的网关
5. 当处理成员数 ≤500 的群组消息时，im-logic 应对所有在线成员执行实时消息扇出
6. 当处理成员数 >500 的群组消息时，im-logic 应委托给 im-task 进行异步处理
7. 当检测到重复消息时，im-logic 应使用基于 Redis 的去重来防止重复处理
8. 当请求会话数据时，im-logic 应聚合包含未读计数和最后消息信息的会话列表

### 需求 4: 网关服务 (im-gateway)

**用户故事:** 作为前端开发者，我希望有一个处理客户端连接和协议转换的网关服务，以便 Web 和移动客户端可以通过 WebSocket 和 HTTP API 与后端通信。

#### 验收标准

1. 当客户端通过 WebSocket 连接时，im-gateway 应验证 JWT 令牌并建立持久连接
2. 当客户端通过 WebSocket 发送消息时，im-gateway 应验证消息并发布到 Kafka 上游主题
3. 当消息发布到 Kafka 时，im-gateway 应立即向客户端发送确认以优化 UI
4. 当下游消息从 Kafka 到达时，im-gateway 应将消息投递到适当的 WebSocket 连接
5. 当客户端发起 HTTP API 请求时，im-gateway 应将请求转换为对 im-logic 的 gRPC 调用并返回响应
6. 当建立 WebSocket 连接时，im-gateway 应在 Redis 中注册用户会话以供服务发现
7. 当客户端断开连接时，im-gateway 应清理连接状态并更新用户会话信息
8. 当发生连接错误时，im-gateway 应实现适当的错误处理和连接恢复机制

### 需求 5: 任务处理服务 (im-task)

**用户故事:** 作为系统管理员，我希望有一个异步任务处理服务来处理繁重操作而不阻塞实时消息流，以便系统能够在处理后台任务的同时为关键操作维持低延迟。

#### 验收标准

1. 当大群消息分发任务到达时，im-task 应异步处理成员扇出
2. 当处理大群时，im-task 应批量查找成员并高效分发消息
3. 当任务处理失败时，im-task 应实现带有指数退避的重试逻辑
4. 当任务完成时，im-task 应记录处理指标用于监控和告警
5. 当系统负载高时，im-task 应通过 Kafka 消费者组支持水平扩展
6. 当需要离线推送通知时，im-task 应与外部推送服务集成（未来扩展性）
7. 当需要内容审核时，im-task 应为内容分析服务提供钩子（未来扩展性）
8. 当需要数据归档时，im-task 应支持后台数据管理操作（未来扩展性）

### 需求 6: 系统集成和通信

**用户故事:** 作为 DevOps 工程师，我希望所有服务都能可靠通信并具有可观测性，以便系统能够在规模化运行时具有适当的监控、日志记录和错误处理。

#### 验收标准

1. 当服务启动时，它们应向 etcd 服务发现注册并执行健康检查
2. 当服务通信时，它们应使用 gRPC 进行同步操作，具有适当的超时处理
3. 当服务需要异步通信时，它们应使用 Kafka，具有适当的消息序列化和错误处理
4. 当任何操作发生时，服务应生成带有 trace ID 的结构化日志用于分布式追踪
5. 当发生错误时，服务应实现熔断器模式以防止级联故障
6. 当服务部署时，它们应暴露健康检查端点供 Kubernetes 探针使用
7. 当需要系统指标时，服务应暴露 Prometheus 指标用于监控
8. 当配置更改时，服务应支持从 etcd 热重载而无需重启

### 需求 7: 数据一致性和可靠性

**用户故事:** 作为用户，我希望我的消息能够可靠且一致地投递，以便我可以信任消息系统进行重要通信。

#### 验收标准

1. 当处理消息时，系统应使用客户端生成的消息 ID 确保恰好一次处理
2. 当存储消息时，它们应通过适当的事务处理原子性持久化
3. 当生成序列号时，它们应使用 Redis INCR 在每个会话中单调递增
4. 当缓存和数据库变得不一致时，系统应优先使用数据库数据并使缓存失效
5. 当发生网络分区时，服务应优雅处理部分故障而不丢失数据
6. 当系统重启时，消息处理应从 Kafka 中最后提交的偏移量恢复
7. 当发生并发操作时，系统应使用适当的锁定机制来防止竞态条件
8. 当检测到数据损坏时，系统应记录错误并尝试恢复程序