# 微服务架构实施任务列表

## 1. 项目结构和基础设施搭建

- [x] 1.1 创建四个微服务的项目目录结构
  - 创建 im-gateway、im-logic、im-repo、im-task 服务目录
  - 为每个服务创建标准的 Go 项目结构（cmd、internal、api、configs 等）
  - 创建统一的 Makefile 和 Docker 构建脚本
  - _需求: 6.1, 6.4_

- [x] 1.2 定义 protobuf 接口文件
  - 创建 api/proto 目录存放所有 protobuf 定义
  - 编写 im-logic 服务的 gRPC 接口定义（AuthService、ConversationService、GroupService）
  - 编写 im-repo 服务的 gRPC 接口定义（UserService、MessageService、GroupService、ConversationService、OnlineStatusService）
  - 生成 Go 代码和 gRPC 客户端/服务端代码
  - _需求: 1.3, 2.4, 3.4, 4.4_

- [x] 1.3 创建 Kafka 消息协议定义
  - 定义上行消息结构（UpstreamMessage）
  - 定义下行消息结构（DownstreamMessage）
  - 定义任务消息结构（TaskMessage）
  - 创建消息序列化和反序列化工具
  - _需求: 1.1, 2.6, 5.2_

## 2. im-gateway 网关服务实现

- [ ] 2.1 实现 HTTP 服务器和路由
  - 使用 Gin 框架创建 HTTP 服务器
  - 实现用户认证相关 API 路由（/api/v1/auth/*）
  - 实现会话管理 API 路由（/api/v1/conversations/*）
  - 实现群组管理 API 路由（/api/v1/groups/*）
  - 添加 JWT 中间件进行身份验证
  - _需求: 2.2, 7.1_

- [ ] 2.2 实现 WebSocket 连接管理
  - 使用 gorilla/websocket 实现 WebSocket 升级
  - 实现连接池管理和心跳检测
  - 实现 WebSocket 消息协议处理（send-message、new-message、ping/pong）
  - 实现连接状态在 Redis 中的注册和清理
  - _需求: 2.1, 2.6_

- [ ] 2.3 实现 gRPC 客户端调用
  - 创建 im-logic 服务的 gRPC 客户端
  - 实现服务发现和负载均衡
  - 实现 HTTP API 到 gRPC 调用的转换
  - 添加超时和重试机制
  - _需求: 2.4, 1.1_

- [ ] 2.4 实现 Kafka 消息处理
  - 实现上行消息生产者，将客户端消息发送到 im-upstream-topic
  - 实现下行消息消费者，从 im-downstream-topic-{gateway_id} 消费消息
  - 实现消息到 WebSocket 客户端的推送
  - 添加消息确认和错误处理机制
  - _需求: 2.5, 1.2_

## 3. im-logic 业务逻辑服务实现

- [ ] 3.1 实现 gRPC 服务端框架
  - 创建 gRPC 服务器和服务注册
  - 实现 AuthService 的所有方法（Login、Register、RefreshToken、Logout）
  - 实现 ConversationService 的所有方法（GetConversations、GetMessages、MarkAsRead）
  - 实现 GroupService 的所有方法（CreateGroup、JoinGroup、LeaveGroup、GetGroupMembers）
  - _需求: 3.2, 3.3, 7.1, 7.2, 7.3_

- [ ] 3.2 实现消息处理核心逻辑
  - 创建 Kafka 上行消息消费者
  - 实现消息幂等性检查（通过 im-repo 调用）
  - 实现消息持久化优先策略
  - 实现消息 ID 和序列号生成
  - _需求: 3.1, 7.4, 7.5_

- [ ] 3.3 实现消息分发策略
  - 实现消息分发决策器（单聊、中小群、超大群）
  - 实现单聊消息的实时分发
  - 实现中小群消息的实时扩散（≤500人）
  - 实现超大群消息的异步任务投递（>500人）
  - _需求: 3.4, 3.6_

- [ ] 3.4 实现 im-repo 服务调用
  - 创建 im-repo 各服务的 gRPC 客户端
  - 实现用户数据操作调用
  - 实现消息数据操作调用
  - 实现群组数据操作调用
  - 实现在线状态管理调用
  - _需求: 3.5, 1.1_

## 4. im-repo 数据仓储服务实现

- [x] 4.1 实现数据库模型和迁移
  - 定义 GORM 数据模型（User、Group、GroupMember、Message、UserReadPointer）
  - 创建数据库迁移脚本
  - 实现数据库连接和连接池配置
  - 添加数据库健康检查
  - _需求: 4.4, 4.6_

- [x] 4.2 实现缓存管理器
  - 实现 Redis 连接和连接池配置
  - 实现缓存键定义和管理
  - 实现 Cache-Aside 缓存策略
  - 实现"更新数据库+删除缓存"的写策略
  - _需求: 4.2, 4.3_

- [ ] 4.3 修复用户数据服务实现
  - 修复 UserService gRPC 服务端的 import 问题
  - 完善用户仓储层的方法实现（BatchGetUsers、DeleteUser 等）
  - 修复密码验证方法的返回值问题
  - 完善用户信息缓存策略
  - _需求: 4.1, 4.5_

- [ ] 4.4 修复消息数据服务实现
  - 修复 MessageService gRPC 服务端的 import 问题
  - 修复消息仓储层的数据类型转换问题
  - 完善消息查询方法的返回值处理
  - 实现会话仓储层（ConversationRepository）
  - _需求: 4.1, 4.5, 7.4_

- [x] 4.5 实现群组数据服务
  - 实现 GroupService gRPC 服务端
  - 实现群组创建、查询、成员管理操作
  - 实现群组成员列表缓存（SET）
  - 实现批量在线状态查询优化
  - _需求: 4.1, 4.5, 7.3_

- [x] 4.6 实现会话数据服务
  - 实现 ConversationService gRPC 服务端
  - 实现会话列表查询和管理
  - 实现用户已读位置更新和查询
  - 实现未读消息数统计
  - _需求: 4.1, 4.5, 7.5_

- [x] 4.7 实现在线状态服务
  - 实现 OnlineStatusService gRPC 服务端
  - 实现用户在线状态的设置和查询
  - 实现批量在线状态查询
  - 实现在线状态的 TTL 管理
  - _需求: 4.1, 4.5, 7.6_

- [x] 4.8 完善 im-repo 服务集成
  - 修复所有 gRPC 服务的 protobuf import 问题
  - 实现 im-repo 主服务器启动和服务注册
  - 添加服务健康检查和优雅关闭
  - 完善配置管理和错误处理
  - _需求: 4.4, 6.4_

## 5. im-task 异步任务服务实现

- [ ] 5.1 实现任务分发器框架
  - 创建任务分发器（TaskDispatcher）
  - 定义任务处理器接口（TaskProcessor）
  - 实现任务类型注册和路由机制
  - 实现 Kafka 任务消息消费者
  - _需求: 5.2, 5.6_

- [ ] 5.2 实现大群消息扩散处理器
  - 实现 FanoutProcessor 任务处理器
  - 实现分批获取群组成员逻辑
  - 实现批量在线状态查询
  - 实现批量下行消息生产
  - 添加错误处理和重试机制
  - _需求: 5.3, 1.2_

- [ ] 5.3 实现数据索引处理器
  - 实现 IndexProcessor 任务处理器
  - 集成 Elasticsearch 客户端
  - 实现消息数据的索引创建和更新
  - 实现索引删除和错误恢复
  - _需求: 5.5_

- [ ] 5.4 实现推送服务处理器
  - 实现 PushProcessor 任务处理器
  - 集成第三方推送服务 API（APNs、FCM）
  - 实现离线用户的推送通知
  - 实现推送失败的重试和降级策略
  - _需求: 5.4_

- [ ] 5.5 实现任务监控和管理
  - 实现任务执行状态监控
  - 实现死信队列处理
  - 实现任务执行指标收集
  - 添加任务处理的日志和追踪
  - _需求: 5.1, 6.5_

- [ ] 5.6 完善 im-task 服务集成
  - 实现 im-task 主服务器启动和任务分发器初始化
  - 集成所有任务处理器到分发器
  - 添加服务健康检查和优雅关闭
  - 完善配置管理和错误处理
  - _需求: 5.1, 6.4_

## 6. 服务间集成和通信

- [ ] 6.1 实现 im-logic 与 im-repo 的 gRPC 集成
  - 在 im-logic 中创建 im-repo 各服务的 gRPC 客户端
  - 实现服务发现和连接管理
  - 添加调用超时和重试机制
  - 实现错误处理和降级策略
  - _需求: 3.5, 1.1_

- [ ] 6.2 实现 im-gateway 与 im-logic 的 gRPC 集成
  - 在 im-gateway 中创建 im-logic 各服务的 gRPC 客户端
  - 实现 HTTP API 到 gRPC 调用的转换
  - 添加请求验证和错误处理
  - 实现负载均衡和故障转移
  - _需求: 2.4, 1.1_

- [ ] 6.3 实现 Kafka 消息队列集成
  - 在 im-gateway 中实现 Kafka 生产者和消费者
  - 在 im-logic 中实现 Kafka 消息处理
  - 在 im-task 中实现 Kafka 任务消费
  - 添加消息序列化和错误处理
  - _需求: 1.2, 2.5, 5.2_

## 7. 配置和部署

- [ ] 7.1 实现配置管理
  - 为每个服务创建配置文件结构
  - 实现基于 etcd 的配置中心集成
  - 实现配置热更新机制
  - 添加配置验证和默认值处理
  - _需求: 6.4, 1.5_

- [ ] 7.2 实现服务发现和注册
  - 集成 im-infra/coord 进行服务注册
  - 实现服务健康检查
  - 实现 gRPC 客户端的服务发现
  - 添加服务优雅启动和关闭
  - _需求: 1.5, 6.4_

- [ ] 7.3 创建 Docker 和部署配置
  - 为每个服务创建 Dockerfile
  - 创建 docker-compose.yml 用于本地开发
  - 创建 Kubernetes 部署配置
  - 实现服务间网络和安全配置
  - _需求: 6.4_

## 8. 核心功能集成测试

- [ ] 8.1 实现用户认证流程测试
  - 测试用户注册、登录、JWT 验证完整流程
  - 测试 WebSocket 连接建立和身份验证
  - 测试用户在线状态的正确设置和清理
  - _需求: 7.1, 7.6_

- [ ] 8.2 实现单聊功能测试
  - 测试单聊消息发送和接收完整流程
  - 测试消息持久化和序列号生成
  - 测试消息幂等性和去重机制
  - 测试实时消息推送和确认
  - _需求: 7.2, 7.4, 7.7_

- [ ] 8.3 实现群聊功能测试
  - 测试群组创建、加入、退出流程
  - 测试中小群消息的实时扩散
  - 测试超大群消息的异步处理
  - 测试群组成员管理和权限控制
  - _需求: 7.3, 7.4_

- [ ] 8.4 实现会话管理测试
  - 测试会话列表获取和排序
  - 测试历史消息查询和分页
  - 测试消息已读状态和未读计数
  - 测试会话状态的实时同步
  - _需求: 7.5, 7.7_

## 9. 性能优化和监控

- [ ] 9.1 实现日志和追踪
  - 为所有服务添加结构化日志输出
  - 实现分布式链路追踪（TraceID）
  - 添加关键业务指标的日志记录
  - 实现日志聚合和查询
  - _需求: 6.5_

- [ ] 9.2 实现监控和指标
  - 集成 Prometheus 指标收集
  - 实现服务健康检查端点
  - 添加业务指标监控（消息量、在线用户数等）
  - 创建监控大盘和告警规则
  - _需求: 6.5_

- [ ] 9.3 性能测试和优化
  - 实现 WebSocket 连接压力测试
  - 测试消息吞吐量和延迟
  - 优化数据库查询和缓存策略
  - 测试服务水平扩展能力
  - _需求: 4.5, 2.1_

## 10. 文档和示例

- [ ] 10.1 编写 API 文档
  - 创建 HTTP API 接口文档
  - 创建 WebSocket 协议文档
  - 创建 gRPC 接口文档
  - 添加接口使用示例和错误码说明
  - _需求: 6.2_

- [ ] 10.2 创建部署和运维文档
  - 编写服务部署指南
  - 创建配置参数说明文档
  - 编写故障排查和运维手册
  - 添加性能调优建议
  - _需求: 6.2, 6.4_

- [ ] 10.3 创建开发示例
  - 创建客户端集成示例代码
  - 编写单元测试和集成测试示例
  - 创建本地开发环境搭建指南
  - 添加代码规范和贡献指南
  - _需求: 6.2, 6.6_