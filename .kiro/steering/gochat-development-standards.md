---
inclusion: always
---

# GoChat 开发标准

## 项目概述
GoChat 是一个基于 Go 构建的分布式即时通讯系统，采用微服务架构，包含四个核心服务：im-gateway、im-logic、im-task 和 im-repo。

## 架构原则

### 微服务设计
- **im-gateway**: 协议转换、用户认证、WebSocket 连接管理
- **im-logic**: 核心业务逻辑、消息处理和分发、会话管理  
- **im-task**: 异步任务处理、大群消息扇出、离线推送
- **im-repo**: 统一数据访问、缓存策略、数据持久化

### 服务通信
- **同步通信**: 使用 gRPC 进行服务间实时请求-响应操作
- **异步通信**: 使用 Kafka 进行服务解耦、缓冲和任务分发
- **外部通信**: 使用 HTTP REST API 和 WebSocket 与客户端通信

## 代码标准

### Go 代码风格
- 遵循标准 Go 约定并使用 `gofmt`
- 使用有意义的英文变量名和函数名
- 为导出的函数和类型添加完整注释
- 实现适当的错误处理，包含上下文和结构化日志

### 项目结构
```
service-name/
├── cmd/           # 主应用程序
├── internal/      # 私有应用代码
├── pkg/           # 公共库代码
├── api/           # 协议定义 (protobuf)
├── configs/       # 配置文件
├── deployments/   # 部署配置
└── docs/          # 服务特定文档
```

### 错误处理
- 使用带有适当上下文的结构化错误类型
- 记录带有 trace ID 的错误以支持分布式追踪
- 实现适当的重试机制，采用指数退避
- 向客户端返回有意义的错误消息

## 基础设施标准

### 数据库设计
- 所有主键使用 BIGINT UNSIGNED (Snowflake ID)
- 实现适当的索引以优化查询
- 遵循命名约定：表和列使用 snake_case
- 使用事务确保数据一致性

### 缓存策略
- 读操作实现 Cache-Aside 模式
- 写操作使用 Write-Through 模式
- 为不同数据类型设置适当的 TTL 值
- 优雅处理缓存失败（降级到数据库）

### 消息队列
- 所有异步通信使用 Kafka
- 实现适当的消息序列化 (protobuf)
- 所有消息包含 trace_id 用于调试
- 处理消息去重和排序

## 安全要求

### 认证与授权
- 使用 JWT 令牌进行无状态认证
- 实现适当的令牌验证和过期机制
- 使用 bcrypt 进行密码哈希
- 验证所有用户输入并清理数据

### 数据保护
- 所有通信启用 TLS/SSL
- 静态敏感数据加密
- 实现适当的访问控制
- 记录安全事件用于审计

## 性能指南

### 优化策略
- 对数据库和 Redis 使用连接池
- 实现适当的缓存层
- 尽可能使用批量操作
- 监控和优化慢查询

### 可扩展性设计
- 设计所有服务为无状态
- 使用水平扩展策略
- 实现适当的负载均衡
- 规划数据分区和分片

## 监控与可观测性

### 日志标准
- 使用 zap 进行结构化日志记录 (JSON 格式)
- 所有日志条目包含 trace_id
- 在适当级别记录日志 (DEBUG, INFO, WARN, ERROR)
- 避免记录敏感信息

### 指标收集
- 监控黄金信号：延迟、流量、错误、饱和度
- 使用 Prometheus 进行指标收集
- 实现自定义业务指标
- 设置适当的告警阈值

### 分布式追踪
- 使用 OpenTelemetry 进行追踪收集
- 跨服务边界传播追踪上下文
- 包含有意义的 span 名称和属性
- 监控追踪采样率

## 测试标准

### 单元测试
- 达到最低 80% 代码覆盖率
- 适当使用表驱动测试
- 正确模拟外部依赖
- 测试错误条件和边界情况

### 集成测试
- 使用真实依赖测试服务交互
- 使用 testcontainers 进行数据库测试
- 实现适当的测试数据管理
- 测试失败场景和恢复

## 部署标准

### 容器化
- 使用多阶段 Docker 构建进行优化
- 基于 alpine 镜像确保安全性和大小
- 实现适当的健康检查
- 在容器中使用非 root 用户

### Kubernetes 部署
- 实现适当的资源限制和请求
- 使用 ConfigMaps 和 Secrets 进行配置
- 实现就绪性和存活性探针
- 使用 HPA 进行自动扩展

## 开发工作流

### 代码审查流程
- 所有代码合并前必须经过审查
- 检查是否遵循编码标准
- 验证测试覆盖率和质量
- 审查安全影响

### 版本控制
- 发布使用语义化版本
- 编写有意义的提交消息
- 开发使用功能分支
- 正确标记发布版本

## 配置管理

### 环境配置
- 使用环境特定的配置文件
- 尽可能支持配置热重载
- 启动时验证配置
- 使用 etcd 进行分布式配置

### 密钥管理
- 永远不要将密钥提交到版本控制
- 使用 Kubernetes Secrets 或外部密钥管理器
- 定期轮换密钥
- 审计密钥访问

## 文档要求

### 代码文档
- 为所有公共 API 提供示例文档
- 维护最新的 README 文件
- 记录配置选项
- 包含故障排除指南

### API 文档
- REST API 使用 OpenAPI/Swagger
- 为 gRPC 服务提供适当的注释文档
- 包含请求/响应示例
- 记录错误代码和含义