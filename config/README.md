# GoChat 配置管理

本目录包含 GoChat 项目的所有配置文件和配置管理工具。我们遵循“分层配置”和“消除冗余”的核心原则。

## 🎯 核心理念

1.  **分层配置 (Layered Configuration)**: 配置被清晰地分为两层：
    *   **全局配置 (`global`)**: 定义所有服务共享的基础设施和中间件连接（如数据库、缓存、消息队列）。这些配置是环境的唯一真实来源。
    *   **应用配置 (`<service-name>`)**: 定义每个服务自身的、独特的配置（如服务名）。

2.  **消除冗余 (Don't Repeat Yourself - DRY)**: 通用组件（日志、指标、中间件）的配置在 `global` 目录中只定义一次，所有服务共享这份配置。服务在启动时，会加载全局配置和自己的应用配置，组合成完整的运行时配置。

## 📁 目录结构

```
config/
├── dev/                    # 开发环境配置
│   ├── global/            # 全局共享配置
│   │   ├── cache.json      # 缓存 (Redis)
│   │   ├── clog.json       # 日志 (Clog)
│   │   ├── db.json         # 数据库 (MySQL)
│   │   ├── metrics.json    # 指标与追踪 (Prometheus)
│   │   └── mq.json         # 消息队列 (Kafka)
│   ├── im-gateway/         # 各服务的应用配置目录
│   │   └── app.json
│   ├── im-logic/
│   │   └── app.json
│   ├── im-repo/
│   │   └── app.json
│   └── im-task/
│       └── app.json
├── config-cli/             # 配置管理工具
└── README.md               # 本文件
```

## 🚀 配置加载流程

所有服务遵循统一的配置加载策略：

1.  **加载全局配置**: 首先，从配置中心（etcd）的 `/config/{env}/global/` 路径下加载所有全局组件的配置。
2.  **加载应用配置**: 接着，从 `/config/{env}/{service-name}/` 路径下加载自己的应用配置。
3.  **合并与初始化**: 服务将全局配置和应用配置在内存中合并，并根据这些信息初始化所有组件。例如，`clog` 组件会使用全局的日志配置，并动态注入自己的服务名作为日志字段。

这个流程确保了基础设施配置的统一性，同时给予了应用配置的灵活性。

## 🔧 配置管理

所有配置的修改和同步都遵循一个简单的流程：

1.  **本地修改**: 直接在 `config/dev/` 目录下修改对应的 JSON 文件。
2.  **同步到 etcd**: 在项目根目录运行 `make` 命令，将开发环境的配置推送到 etcd。

```bash
# 在项目根目录运行，同步所有 dev 配置
make config-sync-dev
```

`config-cli` 工具的实现细节和更多用法，请参考其自身的 `README`。

关于配置管理的详细流程和最佳实践，请参阅 **[部署与配置指南](../docs/04_deployment/README.md#配置管理)**。

## 🔐 安全与最佳实践

- **敏感信息**: 生产环境中的 `dsn`、`password` 等敏感信息应通过环境变量或密钥管理服务注入，而不是硬编码在配置文件中。
- **版本控制**: 所有配置文件都应纳入 Git 进行版本控制。
- **CI/CD**: 生产环境的配置变更应遵循严格的 CI/CD 流程，而不是手动执行 `config-cli`。