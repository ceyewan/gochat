# 数据流图

## 1. 整体数据流图

```mermaid
graph TB
    subgraph 客户端层
        ClientA[客户端 A]
        ClientB[客户端 B]
        ClientC[客户端 C]
    end
    
    subgraph 网关层
        GatewayA[im-gateway A]
        GatewayB[im-gateway B]
        GatewayC[im-gateway C]
    end
    
    subgraph 消息队列层
        UpstreamTopic[im-upstream-topic]
        DownstreamTopicA[im-downstream-topic-A]
        DownstreamTopicB[im-downstream-topic-B]
        DownstreamTopicC[im-downstream-topic-C]
        TaskTopic[im-task-topic]
    end
    
    subgraph 业务逻辑层
        Logic[im-logic]
        Task[im-task]
    end
    
    subgraph 数据层
        Repo[im-repo]
        MySQL[(MySQL)]
        Redis[(Redis)]
    end
    
    subgraph 外部服务
        Push[推送服务]
    end
    
    %% 客户端到网关
    ClientA -->|WebSocket| GatewayA
    ClientB -->|WebSocket| GatewayB
    ClientC -->|WebSocket| GatewayC
    
    %% 网关到消息队列
    GatewayA -->|生产者| UpstreamTopic
    GatewayB -->|生产者| UpstreamTopic
    GatewayC -->|生产者| UpstreamTopic
    
    %% 消息队列到逻辑服务
    UpstreamTopic -->|消费者| Logic
    TaskTopic -->|消费者| Task
    
    %% 逻辑服务到下游Topic
    Logic -->|生产者| DownstreamTopicA
    Logic -->|生产者| DownstreamTopicB
    Logic -->|生产者| DownstreamTopicC
    Logic -->|生产者| TaskTopic
    
    %% 下游Topic到网关
    DownstreamTopicA -->|消费者| GatewayA
    DownstreamTopicB -->|消费者| GatewayB
    DownstreamTopicC -->|消费者| GatewayC
    
    %% 网关到客户端
    GatewayA -->|WebSocket| ClientA
    GatewayB -->|WebSocket| ClientB
    GatewayC -->|WebSocket| ClientC
    
    %% 逻辑服务到数据层
    Logic -->|gRPC| Repo
    Task -->|gRPC| Repo
    Repo -->|查询| MySQL
    Repo -->|缓存| Redis
    
    %% 任务服务到推送服务
    Task -->|HTTP| Push
```

## 2. 用户认证数据流图

```mermaid
sequenceDiagram
    participant C as 客户端
    participant G as im-gateway
    participant L as im-logic
    participant R as im-repo
    participant DB as MySQL
    participant Cache as Redis
    
    C->>G: POST /api/v1/auth/login
    Note over C,G: 用户名、密码、设备ID
    
    G->>L: gRPC Authenticate
    Note over G,L: 转发认证请求
    
    L->>R: gRPC GetUser
    Note over L,R: 查询用户信息
    
    R->>DB: SELECT * FROM users WHERE username = ?
    Note over R,DB: 数据库查询
    
    DB-->>R: 用户记录
    R-->>L: 用户信息
    Note over R,L: 包含密码哈希
    
    L->>L: 验证密码
    Note over L: 比较密码哈希
    
    L->>L: 生成JWT Token
    Note over L: Access Token + Refresh Token
    
    L->>R: gRPC UpdateUser
    Note over L,R: 更新登录状态
    
    R->>DB: UPDATE users SET last_login = NOW()
    Note over R,DB: 更新最后登录时间
    
    R->>Cache: SET user:{user_id}
    Note over R,Cache: 缓存用户信息
    
    L->>Cache: SET user_token:{token}
    Note over L,Cache: 缓存Token
    
    L-->>G: 认证成功响应
    Note over L,G: Token + 用户信息
    
    G-->>C: 登录成功响应
    Note over G,C: JWT Token + 用户信息
```

## 3. 单聊消息数据流图

```mermaid
sequenceDiagram
    participant CA as 客户端 A
    participant GA as im-gateway A
    participant UT as im-upstream-topic
    participant L as im-logic
    participant R as im-repo
    participant DT as im-downstream-topic-B
    participant GB as im-gateway B
    participant CB as 客户端 B
    
    CA->>GA: WebSocket 消息
    Note over CA,GA: 发送消息给用户B
    
    GA->>GA: 验证Token
    Note over GA: 验证发送者身份
    
    GA->>UT: Kafka 生产者
    Note over GA,UT: 发送到上游Topic
    
    UT->>L: Kafka 消费者
    Note over UT,L: Logic服务消费消息
    
    L->>L: 验证消息
    Note over L: 检查消息格式和权限
    
    L->>R: gRPC CreateMessage
    Note over L,R: 持久化消息
    
    R->>R: 写入MySQL
    Note over R: 保存消息到数据库
    
    R->>R: 更新Redis缓存
    Note over R: 更新会话最后消息
    
    L->>L: 查询用户B网关
    Note over L: 从缓存获取网关信息
    
    L->>DT: Kafka 生产者
    Note over L,DT: 发送到下游Topic
    
    DT->>GB: Kafka 消费者
    Note over DT,GB: Gateway B消费消息
    
    GB->>GB: 推送给客户端B
    Note over GB: WebSocket推送
    
    GB->>CB: WebSocket 消息
    Note over GB,CB: 送达客户端B
    
    L->>L: 发送确认
    Note over L: 消息处理完成
    
    L->>UT: 提交Offset
    Note over L,UT: 确认消息处理
```

## 4. 群聊消息数据流图

```mermaid
sequenceDiagram
    participant C as 客户端 A
    participant G as im-gateway
    participant UT as im-upstream-topic
    participant L as im-logic
    participant TT as im-task-topic
    participant T as im-task
    participant R as im-repo
    participant DT as 下游Topics
    participant Gs as 多个网关
    participant Cs as 群组成员
    
    C->>G: WebSocket 群聊消息
    Note over C,G: 发送到群组
    
    G->>UT: Kafka 生产者
    Note over G,UT: 发送到上游Topic
    
    UT->>L: Kafka 消费者
    Note over UT,L: Logic服务消费
    
    L->>R: gRPC GetGroup
    Note over L,R: 获取群组信息
    
    R-->>L: 群组信息
    Note over R,L: 包含成员数量
    
    alt 小群 (成员数 < 100)
        L->>R: gRPC GetGroupMembers
        Note over L,R: 获取群组成员
        
        R-->>L: 成员列表
        Note over R,L: 所有成员信息
        
        loop 每个成员
            L->>L: 查询成员网关
            Note over L: 从缓存获取网关
            
            L->>DT: Kafka 生产者
            Note over L,DT: 发送到对应下游Topic
        end
    else 大群 (成员数 >= 100)
        L->>TT: Kafka 生产者
        Note over L,TT: 发送到Task Topic
        
        TT->>T: Kafka 消费者
        Note over TT,T: Task服务消费
        
        T->>R: gRPC GetGroupMembers
        Note over T,R: 获取群组成员
        
        R-->>T: 成员列表
        Note over R,T: 分页获取成员
        
        loop 批量处理
            T->>DT: Kafka 生产者
            Note over T,DT: 批量发送到下游Topic
        end
    end
    
    DT->>Gs: Kafka 消费者
    Note over DT,Gs: 各网关消费
    
    Gs->>Cs: WebSocket 推送
    Note over Gs,Cs: 推送给群组成员
    
    L->>UT: 提交Offset
    Note over L,UT: 确认消息处理
```

## 5. 离线消息数据流图

```mermaid
sequenceDiagram
    participant L as im-logic
    participant TT as im-task-topic
    participant T as im-task
    participant R as im-repo
    participant DB as MySQL
    participant Cache as Redis
    participant P as 推送服务
    participant Device as 移动设备
    
    L->>L: 检测用户离线
    Note over L: 从缓存检查用户在线状态
    
    L->>TT: Kafka 生产者
    Note over L,TT: 发送离线处理任务
    
    TT->>T: Kafka 消费者
    Note over TT,T: Task服务消费
    
    T->>R: gRPC CreateMessage
    Note over T,R: 持久化消息
    
    R->>DB: INSERT INTO messages
    Note over R,DB: 保存消息到数据库
    
    R->>Cache: SET message:{msg_id}
    Note over R,Cache: 缓存消息信息
    
    T->>R: gRPC UpdateUserStatus
    Note over T,R: 更新用户状态
    
    R->>Cache: SET user_status:{user_id}
    Note over R,Cache: 更新在线状态
    
    T->>P: HTTP 推送请求
    Note over T,P: 发送推送通知
    
    P->>P: 处理推送
    Note over P: 根据平台选择推送方式
    
    P->>Device: APNS/FCM 推送
    Note over P,Device: 推送到移动设备
    
    Device-->>P: 推送结果
    Note over Device,P: 推送成功/失败
    
    P-->>T: 推送结果
    Note over P,T: 返回推送状态
    
    T->>R: gRPC LogPushResult
    Note over T,R: 记录推送日志
    
    T->>TT: 提交Offset
    Note over T,TT: 确认任务处理
```

## 6. 会话管理数据流图

```mermaid
sequenceDiagram
    participant C as 客户端
    participant G as im-gateway
    participant L as im-logic
    participant R as im-repo
    participant DB as MySQL
    participant Cache as Redis
    participant Members as 会话成员
    
    C->>G: POST /api/v1/conversations/create
    Note over C,G: 创建会话请求
    
    G->>L: gRPC CreateConversation
    Note over G,L: 转发创建请求
    
    L->>L: 验证参数
    Note over L: 检查会话类型和成员
    
    L->>R: gRPC CreateConversation
    Note over L,R: 创建会话记录
    
    R->>DB: INSERT INTO conversations
    Note over R,DB: 保存会话信息
    
    R->>DB: INSERT INTO conversation_participants
    Note over R,DB: 保存会话参与者
    
    R->>Cache: SET conversation:{conv_id}
    Note over R,Cache: 缓存会话信息
    
    R->>Cache: SET user_conversations:{user_id}
    Note over R,Cache: 更新用户会话列表
    
    R-->>L: 会话创建成功
    Note over R,L: 返回会话信息
    
    L->>L: 通知会话成员
    Note over L: 发送会话创建通知
    
    loop 每个成员
        L->>L: 查询成员网关
        Note over L: 从缓存获取网关信息
        
        L->>Members: WebSocket 通知
        Note over L,Members: 发送会话创建通知
    end
    
    L-->>G: 创建成功响应
    Note over L,G: 返回会话信息
    
    G-->>C: 会话创建成功
    Note over G,C: 返回会话ID和信息
```

## 7. 群组管理数据流图

```mermaid
sequenceDiagram
    participant C as 客户端
    participant G as im-gateway
    participant L as im-logic
    participant R as im-repo
    participant DB as MySQL
    participant Cache as Redis
    participant Members as 群组成员
    
    C->>G: POST /api/v1/groups/create
    Note over C,G: 创建群组请求
    
    G->>L: gRPC CreateGroup
    Note over G,L: 转发创建请求
    
    L->>L: 验证权限
    Note over L: 检查创建者权限
    
    L->>R: gRPC CreateGroup
    Note over L,R: 创建群组记录
    
    R->>DB: INSERT INTO groups
    Note over R,DB: 保存群组信息
    
    R->>Cache: SET group:{group_id}
    Note over R,Cache: 缓存群组信息
    
    R-->>L: 群组创建成功
    Note over R,L: 返回群组信息
    
    L->>R: gRPC AddGroupMember
    Note over L,R: 添加群组成员
    
    R->>DB: INSERT INTO group_members
    Note over R,DB: 保存成员信息
    
    R->>Cache: SET group_members:{group_id}
    Note over R,Cache: 缓存成员列表
    
    L->>L: 通知被邀请成员
    Note over L: 发送群组邀请通知
    
    loop 每个成员
        L->>Members: WebSocket 通知
        Note over L,Members: 发送群组邀请通知
    end
    
    L-->>G: 创建成功响应
    Note over L,G: 返回群组信息
    
    G-->>C: 群组创建成功
    Note over G,C: 返回群组ID和信息
```

## 8. 数据缓存流图

```mermaid
graph TB
    subgraph 应用层
        A1[im-logic]
        A2[im-gateway]
        A3[im-task]
    end
    
    subgraph 缓存层
        C1[Redis Cluster]
        C2[本地缓存]
    end
    
    subgraph 数据层
        D1[MySQL Master]
        D2[MySQL Slave]
    end
    
    %% 缓存查询流程
    A1 -->|1. 查询缓存| C1
    C1 -->|2. 缓存命中| A1
    C1 -->|3. 缓存未命中| D2
    D2 -->|4. 查询数据库| A1
    A1 -->|5. 更新缓存| C1
    
    %% 缓存更新流程
    A1 -->|1. 更新数据库| D1
    D1 -->|2. 同步到从库| D2
    A1 -->|3. 删除缓存| C1
    
    %% 本地缓存流程
    A2 -->|1. 查询本地缓存| C2
    C2 -->|2. 本地缓存命中| A2
    C2 -->|3. 本地缓存未命中| C1
    C1 -->|4. Redis缓存命中| C2
    C1 -->|5. Redis缓存未命中| D2
    D2 -->|6. 查询数据库| A2
    A2 -->|7. 更新本地缓存| C2
    A2 -->|8. 更新Redis缓存| C1
    
    %% 缓存失效流程
    A3 -->|1. 发布失效消息| C1
    C1 -->|2. 订阅失效消息| A1
    C1 -->|3. 订阅失效消息| A2
    A1 -->|4. 删除本地缓存| C2
    A2 -->|5. 删除本地缓存| C2
```

## 9. 服务发现数据流图

```mermaid
sequenceDiagram
    participant S as 服务实例
    participant E as etcd
    participant C as 客户端
    participant LB as 负载均衡器
    
    S->>E: 服务注册
    Note over S,E: 注册服务信息
    
    E-->>S: 注册成功
    Note over E,S: 返回租约ID
    
    loop 心跳保持
        S->>E: 心跳请求
        Note over S,E: 保持租约活性
        
        E-->>S: 心跳响应
        Note over E,S: 确认服务存活
    end
    
    C->>LB: 服务发现请求
    Note over C,LB: 请求服务地址
    
    LB->>E: 查询服务列表
    Note over LB,E: 获取可用服务
    
    E-->>LB: 服务列表
    Note over E,LB: 返回服务实例
    
    LB->>LB: 选择服务实例
    Note over LB: 负载均衡算法
    
    LB-->>C: 服务地址
    Note over LB,C: 返回最优服务
    
    C->>S: 服务调用
    Note over C,S: 发送请求
    
    S-->>C: 响应结果
    Note over S,C: 返回处理结果
    
    alt 服务下线
        S->>E: 撤销注册
        Note over S,E: 主动下线
        
        E->>E: 删除服务记录
        Note over E: 清理服务信息
        
        E->>LB: 服务变更通知
        Note over E,LB: 通知服务下线
    end
```

## 10. 监控数据流图

```mermaid
graph TB
    subgraph 应用层
        A1[im-gateway]
        A2[im-logic]
        A3[im-task]
        A4[im-repo]
    end
    
    subgraph 监控代理
        P1[Prometheus Agent]
        P2[Jaeger Agent]
        P3[Filebeat]
    end
    
    subgraph 监控存储
        M1[Prometheus]
        M2[Jaeger]
        M3[Elasticsearch]
    end
    
    subgraph 监控展示
        G1[Grafana]
        G2[Jaeger UI]
        G3[Kibana]
    end
    
    subgraph 告警系统
        A[Alertmanager]
        N[通知渠道]
    end
    
    %% 指标数据流
    A1 -->|暴露指标| P1
    A2 -->|暴露指标| P1
    A3 -->|暴露指标| P1
    A4 -->|暴露指标| P1
    
    P1 -->|采集指标| M1
    M1 -->|查询数据| G1
    
    %% 链路追踪数据流
    A1 -->|发送追踪| P2
    A2 -->|发送追踪| P2
    A3 -->|发送追踪| P2
    A4 -->|发送追踪| P2
    
    P2 -->|收集追踪| M2
    M2 -->|查询追踪| G2
    
    %% 日志数据流
    A1 -->|输出日志| P3
    A2 -->|输出日志| P3
    A3 -->|输出日志| P3
    A4 -->|输出日志| P3
    
    P3 -->|收集日志| M3
    M3 -->|查询日志| G3
    
    %% 告警数据流
    M1 -->|触发告警| A
    A -->|发送告警| N
    N -->|通知| 用户
```

这些数据流图展示了 GoChat 系统中各个组件之间的数据流转过程，包括：
1. 整体架构数据流
2. 用户认证流程
3. 单聊消息处理
4. 群聊消息处理
5. 离线消息处理
6. 会话管理
7. 群组管理
8. 缓存策略
9. 服务发现
10. 监控系统

每个数据流图都详细描述了数据在系统中的流转路径和处理过程，有助于理解系统的工作原理和数据流向。