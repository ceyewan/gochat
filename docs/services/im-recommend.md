# im-recommend 推荐服务设计

`im-recommend` 是 GoChat 系统的推荐引擎，它通过分析用户的社交网络和行为数据，为用户提供个性化的推荐，旨在提升用户粘性和社交网络的广度。

## 1. 核心职责

1.  **“可能认识的人”推荐**:
    *   这是最核心的推荐场景。通过分析用户的好友关系网络，发现并推荐潜在的好友。
    *   主要依据是“二度人脉”，即拥有共同好友的用户。

2.  **“可能感兴趣的群”推荐**:
    *   根据用户的兴趣标签、已加入的群组、以及群组的活跃度和内容标签，为用户推荐可能感兴趣的新群组。

3.  **异步推荐模型训练与计算**:
    *   推荐结果的生成通常是计算密集型的，不适合实时计算。
    *   `im-recommend` 主要通过**异步/离线**的方式，以后台任务的形式，定期计算和更新推荐结果，并将结果存入 `im-repo` 的缓存或数据库中。

## 2. 架构与设计

`im-recommend` 的核心是一个**后台任务处理器**，它可能被集成在 `im-task` 服务中，或者作为一个独立的、周期性运行的 CronJob。它向上层的 `im-logic` 提供 gRPC 接口，用于拉取已经计算好的推荐结果。

```mermaid
graph TD
    subgraph "数据源"
        A[im-repo (MySQL/Redis)]
    end

    subgraph "im-recommend / im-task 服务"
        B{推荐任务触发器<br>(定时/事件驱动)} --> C[推荐模型计算]
        C -- "分析好友关系/群成员" --> A
        C -- "存储推荐结果" --> A
    end

    subgraph "im-logic 服务"
        D(gRPC Server)
    end
    
    subgraph "客户端"
        E[Client]
    end

    E -- "获取推荐" --> D
    D -- "gRPC 调用" --> A

```

### 2.1 “可能认识的人”计算流程

1.  **数据获取**: 任务启动后，从 `im-repo` 获取用户的好友关系数据，构建一个用户社交关系图（Graph）。
2.  **算法计算**:
    *   **方法一 (基于图算法)**: 遍历图中的节点。对于每个用户 A，找到其所有好友（一度人脉），再找到好友的好友（二度人脉）。排除掉已经是 A 好友的用户后，剩下的二度人脉就是潜在的推荐对象。
    *   **相似度计算**: 使用 **Jaccard 相似度**或 **Adamic-Adar 指数**等算法，计算用户 A 与其每个二度人脉之间的共同好友数量或权重，作为推荐分数。
    *   **方法二 (基于 Embedding)**: 使用 **Node2Vec** 等图嵌入算法，将每个用户节点转换为一个低维向量。在向量空间中，距离相近的用户即为潜在的好友。这种方法能捕捉到更复杂的网络结构。
3.  **结果存储**: 将计算出的 Top-N 推荐结果（例如，为每个用户存储50个得分最高的推荐用户ID）写入 Redis 的一个 `ZSET` 中，`Key` 为 `recommend:user:{user_id}`，`Score` 为推荐分数，`Member` 为被推荐用户的 ID。
4.  **服务提供**: `im-logic` 在收到客户端的推荐请求时，直接从 `im-repo` 读取预先计算好的缓存结果，实现快速响应。

### 2.2 “可能感兴趣的群”计算流程

1.  **数据获取**: 从 `im-repo` 获取群组信息、群成员关系、用户的行为数据（如加群、发言）。
2.  **算法计算**:
    *   **协同过滤 (Collaborative Filtering)**:
        *   **Item-based**: “加入过A群的人，也加入了B群”，计算群组之间的相似度。
        *   **User-based**: “与你相似的用户，加入了C群”，计算用户之间的相似度。
    *   **内容过滤 (Content-based Filtering)**:
        *   为用户和群组打上标签（Tags），例如通过分析群名、群公告、群内高频词等。
        *   为用户推荐与其兴趣标签相匹配的群组。
3.  **结果存储**: 同样，将计算出的 Top-N 推荐群组结果存入 Redis。

## 3. 技术栈

| 用途 | 库/工具 | 说明 |
| :--- | :--- | :--- |
| **基础库** | `im-infra` | 提供统一的基础能力。 |
| **gRPC 客户端** | `im-infra/rpc` | 用于调用 `im-repo` 服务获取数据。 |
| **图计算库 (可选)** | e.g., `gonum/graph` | 用于在内存中构建和分析社交网络图。 |
| **机器学习库 (可选)** | e.g., `Gorgonia` | 如果采用 Embedding 等方法，可能需要。 |
