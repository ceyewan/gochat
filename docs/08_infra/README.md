# 基础设施层 (im-infra) 开发核心规范

`im-infra` 是 GoChat 项目的基石，它提供了一系列高质量、生产级别的基础组件。为了保证整个基础设施层的一致性、可维护性和健壮性，所有组件的设计和实现都必须严格遵守以下核心规范。

> **面向使用者？** 寻找如何在您的服务中使用这些组件？请直接跳转到 -> **[快速上手指南 (Usage Guide)](./usage_guide.md)**

---

## 1. 统一接口设计规范

这是所有组件交互的“契约法”。

### 1.1 构造函数 (`New`)

- **标准签名**: 所有需要实例化、有配置或有依赖的组件，其构造函数**必须**遵循以下签名：
  ```go
  New(ctx context.Context, config *Config, opts ...Option) (Interface, error)
  ```
- **`config` 职责**: `config` 结构体负责传递组件自身的核心、静态配置（例如 `ratelimit` 的规则路径 `RulesPath`）。配置信息应由调用方提供，组件内部不应有拼接或猜测逻辑。
- **`opts` 职责**: `opts ...Option` 负责以选项模式传递所有**外部依赖**（例如 `clog.Logger`, `coord.Provider`, `cache.Provider`）。
- **例外情况**: 对于完全无状态、无依赖的纯工具包（如 `uid/uuid`），可以直接提供包级函数，无需 `New`。

### 1.2 默认配置 (`GetDefaultConfig`)

- **标准签名**: 所有需要配置的组件**必须**提供 `GetDefaultConfig` 方法：
  ```go
  GetDefaultConfig(env string) *Config
  ```
- **环境参数**: `env` 参数支持 `"development"` 和 `"production"` 两种环境，返回针对不同环境优化的默认配置。
- **设计目标**: 减少用户手动构造复杂配置的负担，提供开箱即用的合理默认值。
- **覆盖机制**: 用户仍可根据实际部署环境覆盖特定的配置项（如连接地址、认证信息等）。

### 1.2 接口方法

- **Context-Aware**: 所有可能发生 I/O、阻塞或需要传递追踪信息的接口方法，**必须**接受 `context.Context` 作为其第一个参数。
- **KISS 原则**: 接口应保持最小化。只暴露真正需要被外部调用的核心功能。避免提供只是为了方便内部实现的公共方法。

## 2. 统一配置管理规范

这是保证系统动态性和可运维性的“行政法”。

### 2.1 声明式配置

- 所有可变的配置（如日志级别、限流规则）都应通过 `coord` 在配置中心进行**声明式**管理。
- 组件**严禁**提供命令式的配置修改 API（如 `SetLogLevel`, `AddRule`）。系统的状态应由配置中心这个“唯一真实来源”驱动。

### 2.2 “组件自治”的动态配置

- **标准模式**: 需要支持配置热更新的组件，必须采用“组件自治”模式。
- **实现方式**: 在组件的 `New` 函数中，自行使用注入的 `coord.Provider` 的 `Watch` 功能来监听自身的配置变更，并以线程安全的方式更新内部状态。
- **废弃 `HotReloadable`**: `base.HotReloadable` 接口及其代表的“集中式回调”模式被废弃。

### 2.3 `coord.Watch` 接口能力

- `coord` 组件的 `ConfigCenter.Watch` 接口**必须**支持前缀监听。
- **约定**: 当 `Watch` 方法接收的 `key` 参数以 `/` 结尾时，它应自动启用对该前缀下所有键的监听（`WatchPrefix` 行为）。如果 `key` 不以 `/` 结尾，则只监听单个键。

## 3. 统一代码与文档规范

这是确保项目可读性和可维护性的“组织法”。

### 3.1 代码组织风格

- **标准目录结构**:
  ```
  [component]/
  ├── [component].go  # 公开接口, Config, New()
  ├── options.go      # Option 模式实现
  ├── internal/       # 所有内部实现细节
  │   └── client.go   # 接口的具体实现结构体及方法
  ├── README.md       # 快速上手指南 (给开发者)
  └── DESIGN.md       # (可选) 深入的设计决策 (给架构师/面试官)
  ```

### 3.2 文档结构

- **`docs/08_infra/[component].md`**: 每个组件的**官方“契约”文档**。这是组件功能、API 和设计理念的最终、唯一真实来源。所有 `im-infra` 的使用者都应首先阅读此文档。
- **`docs/07_todo_task/`**: 作为项目**未来的重构计划书**和**技术路线图 (Roadmap)**，为核心开发者提供方向和设计蓝图。

## 4. 核心组件列表

以下是 `im-infra` 库提供的核心组件及其官方契约文档链接。

- **[日志 (clog)](./clog.md)**
- **[分布式协调 (coord)](./coord.md)**
- **[缓存 (cache)](./cache.md)**
- **[数据库 (db)](./db.md)**
- **[消息队列 (mq)](./mq.md)**
- **[唯一ID (uid)](./uid.md)**
- **[可观测性 (metrics)](./metrics.md)**
- **[幂等操作 (once)](./once.md)**
- **[分布式限流 (ratelimit)](./ratelimit.md)**
- **[优雅重试 (retry)](./retry.md)**
- **[熔断器 (breaker)](./breaker.md)**