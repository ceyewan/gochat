# 日志记录和监控

本文档提供了 GoChat 系统的日志记录和监控基础设施指南。

## 1. 架构

我们采用一套轻量级但功能强大的日志与监控方案，核心组件均与 Grafana Labs 生态系统紧密集成。

-   **日志**: `应用程序 -> Promtail -> Loki -> Grafana`
-   **指标**: `应用程序 -> Prometheus -> Grafana`
-   **追踪**: 通过在日志中注入 `trace_id`，并在 Grafana 中进行关联查询来实现，不再引入独立的分布式追踪系统。

## 2. 组件概述

-   **Promtail**: Loki 的官方日志收集代理。它被配置为自动发现并收集来自 Docker 容器的日志，添加如 `service` 等关键标签，并将其高效地推送到 Loki。
-   **Loki**: 一个水平可扩展、多租户的日志聚合系统。它只索引日志的元数据（标签），而不是全文内容，从而实现了极高的存储和查询效率。
-   **Prometheus**: 一个领先的时间序列数据库，用于抓取和存储所有服务的性能指标。
-   **Grafana**: 一个统一的可视化平台，用于查询、可视化和告警来自 Loki 的日志和来自 Prometheus 的指标。

## 3. 访问仪表板

| 服务   | 地址                 | 凭据               | 目的           |
| --------- | ----------------------- | ------------------------- | ----------------- |
| Grafana   | `http://localhost:3000` | `admin`/`gochat_grafana_2024` | 统一日志和指标 |
| Prometheus| `http://localhost:9090` | -                         | 指标查询          |

## 4. 如何使用

### 查看日志

1.  导航到 Grafana (`http://localhost:3000`) 并登录。
2.  在左侧菜单中选择 "Explore"。
3.  从数据源下拉列表中选择 "Loki"。
4.  使用 LogQL 查询日志。例如：
    -   查询 `im-logic` 服务的所有日志: `{service="im-logic"}`
    -   查询特定追踪ID的所有相关日志: `{trace_id="your-trace-id"}`

### 实现分布式追踪

我们通过日志关联来实现轻量级的分布式追踪：

1.  确保上游服务（如 `im-gateway`）为每个请求生成一个唯一的 `trace_id`。
2.  通过 gRPC 或其他方式调用下游服务时，将 `trace_id` 在上下文中传递。
3.  所有服务在记录日志时，都**必须**使用 `clog` 库将 `trace_id` 和 `service` 名称作为标准字段注入。
4.  在 Grafana 的 Loki 查询界面，使用一个已知的 `trace_id` 进行查询，即可串联起一个完整请求在所有微服务中的日志记录。

## 5. 应用程序日志记录配置

为了与简化的监控堆栈正确集成，应用程序必须：

1.  **记录到标准输出**: `clog` 库应配置为将 JSON 格式的日志直接输出到容器的 `stdout` 或 `stderr`。Promtail 会自动收集这些输出。
2.  **包含关键字段**: 所有日志记录**必须**包含 `service` 和 `trace_id` 字段。这对于在 Grafana 中进行有效的过滤、聚合和追踪至关重要。

更多关于日志记录的规范，请参阅[开发规范 - 日志记录](./../03_development/02_style_guide.md#日志记录规范)。