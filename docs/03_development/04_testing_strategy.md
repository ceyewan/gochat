# GoChat 测试策略与规范

本文档定义了 GoChat 项目的测试策略和规范，旨在确保代码质量、系统稳定性和长期可维护性。所有贡献者都必须遵循本规范。

## 1. 核心原则

1.  **测试驱动开发 (TDD)**: 严格遵循 TDD 流程。在编写任何功能代码之前，必须先编写失败的测试用例。这是保证代码质量和功能正确性的基石。
2.  **拒绝 Mock，拥抱真实环境**: 所有测试（包括单元测试）都必须在真实环境中运行。我们禁止使用 Mock 或 Stub 来模拟依赖项（如数据库、消息队列、缓存等）。
    *   **理由**: Mock 会导致测试与生产环境脱节，产生虚假的自信。只有在真实环境中通过的测试，才能有效证明系统的可靠性。
    *   **执行**: 所有测试都应依赖于通过 `deployment/infrastructure/docker-compose.yml` 启动的完整后端服务。
3.  **分层测试策略**: 我们采用金字塔模型，但对每一层都有明确的“无 Mock”要求。
4.  **自动化与 CI/CD**: 所有测试都必须是自动化的，并集成到 CI/CD 流水线中。`make test` 应作为 `make all` 的一部分，在每次提交前运行。

## 2. 测试类型与实施

### 2.1 单元测试 (Unit Tests)

*   **定义**: 针对单个函数、方法或模块的测试。在 GoChat 中，单元测试也必须连接到真实的数据库、Redis、Kafka 等基础设施。
*   **目标**: 验证代码单元的逻辑正确性。
*   **工具**:
    *   Go: `testing` 标准库、`testify/assert`、`testify/require`。
*   **位置**: 测试文件必须与被测试的源文件位于同一包中，并以 `_test.go` 结尾。
*   **规范**:
    *   每个重要的函数或方法都应有对应的单元测试。
    *   测试用例应覆盖正常路径、边界条件和错误处理。
    *   测试应负责准备数据和清理数据，确保可重复执行。

### 2.2 集成测试 (Integration Tests)

*   **定义**: 测试多个微服务或组件之间的交互。例如，测试从 `im-gateway` 发送消息，经过 `im-logic` 处理，最终存储到 `im-repo` 的完整流程。
*   **目标**: 验证微服务之间的协作是否符合预期，包括 API 调用、消息传递和数据一致性。
*   **工具**:
    *   Go: `testing` 标准库。
    *   HTTP/WebSocket 客户端库。
*   **位置**: 集成测试可以放在专门的 `test` 目录或相关的服务模块中。
*   **规范**:
    *   集成测试应覆盖核心的跨服务业务流程。
    *   测试场景应模拟真实的用户操作。

### 2.3 端到端测试 (End-to-End Tests)

*   **定义**: 从用户界面的角度，模拟真实用户与系统的完整交互。例如，测试用户从登录、发送消息到接收消息的整个过程。
*   **目标**: 确保整个系统作为一个整体，能够满足用户需求和业务目标。
*   **工具**:
    *   前端: Cypress 或 Playwright。
    *   后端: 无需特定工具，通过前端 E2E 测试驱动。
*   **规范**:
    *   E2E 测试应覆盖最关键的用户旅程 (User Journeys)。
    *   测试应在与生产环境尽可能一致的预发布 (Staging) 环境中运行。

### 2.4 压力测试 (Load/Stress Tests)

*   **定义**: 评估系统在高并发负载下的性能、稳定性和资源利用率。
*   **目标**:
    *   确定系统的性能基线和瓶颈。
    *   验证系统是否满足性能要求 (如响应时间、吞吐量)。
    *   确保系统在压力下不会崩溃，并能优雅地降级。
*   **统一工具**: **k6**
    *   **理由**: k6 是一款现代化的、以开发者为中心的开源负载测试工具。它使用 JavaScript 编写测试脚本，易于上手和维护，并能生成详细的性能报告。
*   **位置**: 压测脚本应存放在项目的 `scripts/load-testing` 目录下。
*   **规范**:
    *   必须为核心 API 和业务流程编写 k6 压测脚本。
    *   压测应在专用的、与生产环境配置相同的压测环境中进行。
    *   压测场景应模拟真实的用户行为模式。
    *   每次重大发布前，都应执行一轮完整的压力测试。

## 3. 测试环境与数据

*   **测试环境**: 所有自动化测试都应在由项目根目录的 `Makefile` 提供的统一命令启动的本地环境中运行。这确保了测试环境与开发和生产环境的一致性。
    *   使用 `make infra-up` 启动所有基础设施服务。
    *   使用 `make app-up` 启动所有应用服务。
    *   CI/CD 流水线将使用相同的命令来创建和管理测试环境。
*   **测试数据**: 测试应负责管理自己的生命周期。推荐使用 `setUp` 和 `tearDown` 模式：
    *   `setUp`: 在测试开始前，创建必要的测试数据 (如用户、会话等)。
    *   `tearDown`: 在测试结束后，清理创建的数据，避免对其他测试造成干扰。

## 4. 流程集成

1.  **本地开发**: 开发者在本地使用 `make test` 或 `make all` 运行所有测试。
2.  **代码审查**: 拉取请求 (PR) 必须包含相应的测试代码，并通过代码审查。
3.  **持续集成 (CI)**: CI 服务器会自动运行所有测试。只有当所有测试通过时，PR 才允许被合并。