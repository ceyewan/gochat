# 微服务开发指南

本指南提供了在 GoChat 项目中开发、运行和测试单个微服务的说明和最佳实践。

## 1. 服务结构

每个微服务（例如 `im-logic`、`im-repo`）都遵循一致的目录结构：

-   **/cmd**: 包含 `main.go` 文件，这是服务的入口点。其主要职责是初始化和启动服务。
-   **/internal**: 包含服务的所有私有代码。
    -   **/config**: 处理加载和管理配置。
    -   **/model**: 定义服务内使用的数据结构（结构体），特别是用于数据库交互的数据结构。
    -   **/repository**: 数据访问层。它包含与数据库和缓存交互的逻辑。
    -   **/service**: 业务逻辑层。它实现 `.proto` 文件中定义的 gRPC 服务接口。
-   **/api**: 此目录位于项目根目录，包含所有 `.proto` 定义和生成的代码。

## 2. 在本地运行服务

每个微服务都可以独立运行以进行开发和测试。

1.  **先决条件**: 确保必要的基础设施（数据库、缓存等）正在运行。您可以使用 `deployment` 目录中的脚本启动它：
    ```bash
    ./deployment/scripts/start-infra.sh
    ```
2.  **运行服务**: 导航到服务的目录并使用 `go run` 命令：
    ```bash
    cd im-repo
    go run ./cmd/server/main.go
    ```

## 3. 添加新的 gRPC 方法

1.  **在 `.proto` 中定义**: 将新的 RPC 方法添加到 `api/proto/` 中相关 `.proto` 文件中的适当服务定义中。
2.  **生成代码**: 运行 `make proto` 命令来自动生成所有 Protobuf 代码。
    ```bash
    make proto
    ```
3.  **在仓储中实现（如果需要）**: 如果新方法需要数据访问，请将相应的函数添加到 `im-repo/internal/repository/` 中的适当仓储文件中。
4.  **在服务中实现**: 在相应的服务文件中实现新的 gRPC 方法（例如 `im-logic/internal/service/user_service.go`）。这是业务逻辑所在的位置。
5.  **编写测试**: 为新的仓储和服务函数添加单元测试。

## 4. 测试

-   **单元测试**: `service` 和 `repository` 层中的每个新函数都应有相应的单元测试。
    -   为依赖项使用模拟（例如，在测试服务时模拟仓储）。
    -   测试文件应命名为 `_test.go`。
-   **集成测试**: 对于更复杂的功能，可以添加集成测试以测试服务之间的交互。这些测试通常针对通过 Docker 启动的真实数据库和其他基础设施组件运行。
-   **运行测试**: 使用 `make test` 命令来运行项目中所有的单元测试，并自动启用竞态分析。
    ```bash
    make test
    ```
    - 如果你想运行所有检查（格式化、静态分析和测试），可以直接使用 `make all`。
    ```bash
    make all
    ```

## 5. 依赖管理

-   依赖项使用 Go Modules 管理。
-   要添加新的依赖项，请使用 `go get <package-name>`。
-   添加或更新依赖项后，运行 `go mod tidy` 以清理 `go.mod` 和 `go.sum` 文件。