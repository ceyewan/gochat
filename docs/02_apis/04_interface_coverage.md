# GoChat æ¥å£è¦†ç›–æ¸…å•

æœ¬æ–‡æ¡£æä¾› GoChat ç³»ç»Ÿæ‰€æœ‰æ¥å£çš„å®Œæ•´æ¸…å•ï¼Œç¡®ä¿æ²¡æœ‰é—æ¼é‡è¦åŠŸèƒ½ã€‚

## 1. HTTP API æ¥å£æ¸…å•

### 1.1 è®¤è¯ç›¸å…³ (`/auth`)
| æ¥å£ | æ–¹æ³• | æè¿° | æ–‡æ¡£è¦†ç›– | å®ç°çŠ¶æ€ |
|------|------|------|----------|----------|
| `/auth/register` | POST | ç”¨æˆ·æ³¨å†Œ | âœ… | âœ… |
| `/auth/login` | POST | ç”¨æˆ·ç™»å½• | âœ… | âœ… |
| `/auth/guest` | POST | æ¸¸å®¢ç™»å½• | âœ… | âœ… |
| `/auth/logout` | POST | ç”¨æˆ·ç™»å‡º | âœ… | âœ… |
| `/auth/refresh` | POST | åˆ·æ–°ä»¤ç‰Œ | âœ… | ğŸ“‹ |

### 1.2 ç”¨æˆ·ç›¸å…³ (`/users`)
| æ¥å£ | æ–¹æ³• | æè¿° | æ–‡æ¡£è¦†ç›– | å®ç°çŠ¶æ€ |
|------|------|------|----------|----------|
| `/users/profile` | GET | è·å–ç”¨æˆ·èµ„æ–™ | âœ… | âœ… |
| `/users/profile` | PUT | æ›´æ–°ç”¨æˆ·èµ„æ–™ | âœ… | ğŸ“‹ |
| `/users/search` | GET | æœç´¢ç”¨æˆ· | âœ… | ğŸ“‹ |

### 1.3 å¥½å‹ç®¡ç† (`/friends`)
| æ¥å£ | æ–¹æ³• | æè¿° | æ–‡æ¡£è¦†ç›– | å®ç°çŠ¶æ€ |
|------|------|------|----------|----------|
| `/friends` | GET | è·å–å¥½å‹åˆ—è¡¨ | âœ… | ğŸ“‹ |
| `/friends/requests` | GET | è·å–å¥½å‹ç”³è¯·åˆ—è¡¨ | âœ… | ğŸ“‹ |
| `/friends/requests` | POST | å‘é€å¥½å‹ç”³è¯· | âœ… | ğŸ“‹ |
| `/friends/requests/{id}` | PUT | å¤„ç†å¥½å‹ç”³è¯· | âœ… | ğŸ“‹ |

### 1.4 ä¼šè¯ç®¡ç† (`/conversations`)
| æ¥å£ | æ–¹æ³• | æè¿° | æ–‡æ¡£è¦†ç›– | å®ç°çŠ¶æ€ |
|------|------|------|----------|----------|
| `/conversations` | GET | è·å–ä¼šè¯åˆ—è¡¨ | âœ… | âœ… |
| `/conversations` | POST | åˆ›å»ºä¼šè¯ | âœ… | âœ… |
| `/conversations/{id}` | GET | è·å–ä¼šè¯è¯¦æƒ… | âœ… | âœ… |
| `/conversations/{id}` | PUT | æ›´æ–°ä¼šè¯ä¿¡æ¯ | âœ… | ğŸ“‹ |
| `/conversations/{id}` | DELETE | åˆ é™¤ä¼šè¯ | âš ï¸ | ğŸ“‹ |
| `/conversations/{id}/messages` | GET | è·å–æ¶ˆæ¯å†å² | âœ… | âœ… |
| `/conversations/{id}/messages` | POST | å‘é€æ¶ˆæ¯ | âœ… | âœ… |
| `/conversations/{id}/read` | PUT | æ ‡è®°å·²è¯» | âœ… | âœ… |

### 1.5 ä¼šè¯æˆå‘˜ç®¡ç† (`/conversations/{id}/members`)
| æ¥å£ | æ–¹æ³• | æè¿° | æ–‡æ¡£è¦†ç›– | å®ç°çŠ¶æ€ |
|------|------|------|----------|----------|
| `/conversations/{id}/members` | GET | è·å–æˆå‘˜åˆ—è¡¨ | âœ… | âœ… |
| `/conversations/{id}/members` | POST | æ·»åŠ æˆå‘˜ | âœ… | âœ… |
| `/conversations/{id}/members/{userId}` | DELETE | ç§»é™¤æˆå‘˜ | âœ… | âœ… |
| `/conversations/{id}/members/{userId}` | PUT | æ›´æ–°æˆå‘˜è§’è‰² | âœ… | âœ… |

## 2. WebSocket æ¶ˆæ¯ç±»å‹æ¸…å•

### 2.1 å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨æ¶ˆæ¯
| æ¶ˆæ¯ç±»å‹ | æè¿° | æ–‡æ¡£è¦†ç›– | å®ç°çŠ¶æ€ |
|----------|------|----------|----------|
| `send-message` | å‘é€æ¶ˆæ¯ | âœ… | âœ… |
| `mark-read` | æ ‡è®°å·²è¯» | âœ… | âœ… |
| `ping` | å¿ƒè·³ä¿æ´» | âœ… | âœ… |
| `typing` | æ­£åœ¨è¾“å…¥ | âŒ | ğŸ“‹ |
| `stop-typing` | åœæ­¢è¾“å…¥ | âŒ | ğŸ“‹ |

### 2.2 æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯æ¶ˆæ¯
| æ¶ˆæ¯ç±»å‹ | æè¿° | æ–‡æ¡£è¦†ç›– | å®ç°çŠ¶æ€ |
|----------|------|----------|----------|
| `new-message` | æ–°æ¶ˆæ¯é€šçŸ¥ | âœ… | âœ… |
| `message-ack` | æ¶ˆæ¯ç¡®è®¤ | âœ… | âœ… |
| `online-status` | åœ¨çº¿çŠ¶æ€æ›´æ–° | âœ… | âœ… |
| `pong` | å¿ƒè·³å“åº” | âœ… | âœ… |
| `error` | é”™è¯¯é€šçŸ¥ | âœ… | âœ… |
| `conversation-updated` | ä¼šè¯æ›´æ–° | âŒ | ğŸ“‹ |
| `member-added` | æˆå‘˜æ·»åŠ  | âŒ | ğŸ“‹ |
| `member-removed` | æˆå‘˜ç§»é™¤ | âŒ | ğŸ“‹ |
| `typing-indicator` | è¾“å…¥çŠ¶æ€ | âŒ | ğŸ“‹ |

## 3. gRPC æ¥å£æ¸…å•

### 3.1 im-logic æœåŠ¡æ¥å£

#### AuthService
| RPC æ–¹æ³• | æè¿° | æ–‡æ¡£è¦†ç›– | å®ç°çŠ¶æ€ |
|----------|------|----------|----------|
| `Login` | ç”¨æˆ·ç™»å½• | âœ… | âœ… |
| `Register` | ç”¨æˆ·æ³¨å†Œ | âœ… | âœ… |
| `GuestLogin` | æ¸¸å®¢ç™»å½• | âœ… | âœ… |
| `RefreshToken` | åˆ·æ–°ä»¤ç‰Œ | âœ… | ğŸ“‹ |
| `Logout` | ç”¨æˆ·ç™»å‡º | âœ… | ğŸ“‹ |
| `ValidateToken` | éªŒè¯ä»¤ç‰Œ | âœ… | âœ… |

#### ConversationService
| RPC æ–¹æ³• | æè¿° | æ–‡æ¡£è¦†ç›– | å®ç°çŠ¶æ€ |
|----------|------|----------|----------|
| `CreateConversation` | åˆ›å»ºä¼šè¯ | âœ… | âœ… |
| `GetConversation` | è·å–ä¼šè¯è¯¦æƒ… | âœ… | âœ… |
| `GetConversations` | è·å–ä¼šè¯åˆ—è¡¨ | âœ… | âœ… |
| `GetConversationsOptimized` | ä¼˜åŒ–ä¼šè¯åˆ—è¡¨æŸ¥è¯¢ | âœ… | ğŸ“‹ |
| `UpdateConversation` | æ›´æ–°ä¼šè¯ä¿¡æ¯ | âš ï¸ | ğŸ“‹ |
| `DeleteConversation` | åˆ é™¤ä¼šè¯ | âš ï¸ | ğŸ“‹ |
| `AddMembers` | æ·»åŠ æˆå‘˜ | âœ… | âœ… |
| `RemoveMembers` | ç§»é™¤æˆå‘˜ | âœ… | âœ… |
| `UpdateMemberRole` | æ›´æ–°æˆå‘˜è§’è‰² | âœ… | âœ… |
| `GetMembers` | è·å–æˆå‘˜åˆ—è¡¨ | âœ… | âœ… |
| `LeaveConversation` | ç¦»å¼€ä¼šè¯ | âš ï¸ | ğŸ“‹ |
| `GetMessages` | è·å–æ¶ˆæ¯å†å² | âœ… | âœ… |
| `MarkAsRead` | æ ‡è®°å·²è¯» | âœ… | âœ… |
| `GetUnreadCount` | è·å–æœªè¯»æ•° | âœ… | âœ… |
| `JoinWorldChat` | åŠ å…¥ä¸–ç•ŒèŠå¤©å®¤ | âš ï¸ | ğŸ“‹ |
| `SearchConversations` | æœç´¢ä¼šè¯ | âš ï¸ | ğŸ“‹ |

#### MessageService
| RPC æ–¹æ³• | æè¿° | æ–‡æ¡£è¦†ç›– | å®ç°çŠ¶æ€ |
|----------|------|----------|----------|
| `SendMessage` | å‘é€æ¶ˆæ¯ | âœ… | âœ… |

#### FriendService (ç¼ºå¤±)
| RPC æ–¹æ³• | æè¿° | æ–‡æ¡£è¦†ç›– | å®ç°çŠ¶æ€ |
|----------|------|----------|----------|
| `SendFriendRequest` | å‘é€å¥½å‹ç”³è¯· | âœ… | âŒ |
| `HandleFriendRequest` | å¤„ç†å¥½å‹ç”³è¯· | âœ… | âŒ |
| `GetFriends` | è·å–å¥½å‹åˆ—è¡¨ | âœ… | âŒ |
| `GetFriendRequests` | è·å–å¥½å‹ç”³è¯· | âœ… | âŒ |
| `SearchUsers` | æœç´¢ç”¨æˆ· | âœ… | âŒ |

### 3.2 im-repo æœåŠ¡æ¥å£

#### UserService
| RPC æ–¹æ³• | æè¿° | æ–‡æ¡£è¦†ç›– | å®ç°çŠ¶æ€ |
|----------|------|----------|----------|
| `CreateUser` | åˆ›å»ºç”¨æˆ· | âœ… | âœ… |
| `GetUser` | è·å–ç”¨æˆ·ä¿¡æ¯ | âœ… | âœ… |
| `GetUsers` | æ‰¹é‡è·å–ç”¨æˆ· | âœ… | âœ… |
| `UpdateUser` | æ›´æ–°ç”¨æˆ·ä¿¡æ¯ | âœ… | ğŸ“‹ |
| `VerifyPassword` | éªŒè¯å¯†ç  | âœ… | âœ… |
| `GetUserByUsername` | æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ· | âœ… | âœ… |
| `SearchUsersByUsername` | æœç´¢ç”¨æˆ· | âœ… | âŒ |

#### ConversationService
| RPC æ–¹æ³• | æè¿° | æ–‡æ¡£è¦†ç›– | å®ç°çŠ¶æ€ |
|----------|------|----------|----------|
| `GetUserConversations` | è·å–ç”¨æˆ·ä¼šè¯åˆ—è¡¨ | âœ… | âœ… |
| `GetUserConversationsWithDetails` | è·å–è¯¦ç»†ä¼šè¯åˆ—è¡¨ | âœ… | ğŸ“‹ |
| `UpdateReadPointer` | æ›´æ–°å·²è¯»ä½ç½® | âœ… | âœ… |
| `GetUnreadCount` | è·å–æœªè¯»æ•° | âœ… | âœ… |
| `GetReadPointer` | è·å–å·²è¯»ä½ç½® | âœ… | âœ… |
| `BatchGetUnreadCounts` | æ‰¹é‡è·å–æœªè¯»æ•° | âœ… | ğŸ“‹ |
| `CreateConversation` | åˆ›å»ºä¼šè¯ | âœ… | âœ… |
| `BatchGetConversations` | æ‰¹é‡è·å–ä¼šè¯ä¿¡æ¯ | âœ… | ğŸ“‹ |
| `AddConversationMember` | æ·»åŠ ä¼šè¯æˆå‘˜ | âœ… | âœ… |
| `RemoveConversationMember` | ç§»é™¤ä¼šè¯æˆå‘˜ | âœ… | âœ… |
| `UpdateMemberRole` | æ›´æ–°æˆå‘˜è§’è‰² | âœ… | âœ… |
| `GetConversationMembers` | è·å–ä¼šè¯æˆå‘˜ | âœ… | âœ… |

#### MessageService
| RPC æ–¹æ³• | æè¿° | æ–‡æ¡£è¦†ç›– | å®ç°çŠ¶æ€ |
|----------|------|----------|----------|
| `SaveMessage` | ä¿å­˜æ¶ˆæ¯ | âœ… | âœ… |
| `GetMessage` | è·å–å•æ¡æ¶ˆæ¯ | âš ï¸ | ğŸ“‹ |
| `GetConversationMessages` | è·å–ä¼šè¯æ¶ˆæ¯åˆ—è¡¨ | âœ… | âœ… |
| `CheckMessageIdempotency` | æ£€æŸ¥æ¶ˆæ¯å¹‚ç­‰æ€§ | âœ… | ğŸ“‹ |
| `GetLatestMessages` | è·å–æœ€æ–°æ¶ˆæ¯ | âš ï¸ | ğŸ“‹ |
| `DeleteMessage` | åˆ é™¤æ¶ˆæ¯ | âœ… | ğŸ“‹ |

#### OnlineStatusService
| RPC æ–¹æ³• | æè¿° | æ–‡æ¡£è¦†ç›– | å®ç°çŠ¶æ€ |
|----------|------|----------|----------|
| `SetUserOnline` | è®¾ç½®ç”¨æˆ·åœ¨çº¿ | âœ… | âœ… |
| `SetUserOffline` | è®¾ç½®ç”¨æˆ·ç¦»çº¿ | âœ… | âœ… |
| `GetUserOnlineStatus` | è·å–åœ¨çº¿çŠ¶æ€ | âœ… | âœ… |
| `GetUsersOnlineStatus` | æ‰¹é‡è·å–åœ¨çº¿çŠ¶æ€ | âœ… | âœ… |
| `UpdateHeartbeat` | æ›´æ–°å¿ƒè·³ | âœ… | ğŸ“‹ |
| `CleanupExpiredStatus` | æ¸…ç†è¿‡æœŸçŠ¶æ€ | âœ… | ğŸ“‹ |

#### FriendService (ç¼ºå¤±)
| RPC æ–¹æ³• | æè¿° | æ–‡æ¡£è¦†ç›– | å®ç°çŠ¶æ€ |
|----------|------|----------|----------|
| `CreateFriendRequest` | åˆ›å»ºå¥½å‹ç”³è¯· | âœ… | âŒ |
| `UpdateFriendRequest` | æ›´æ–°ç”³è¯·çŠ¶æ€ | âœ… | âŒ |
| `GetUserFriends` | è·å–ç”¨æˆ·å¥½å‹ | âœ… | âŒ |
| `GetUserFriendRequests` | è·å–å¥½å‹ç”³è¯· | âœ… | âŒ |

## 4. Kafka æ¶ˆæ¯ç±»å‹æ¸…å•

### 4.1 æ ¸å¿ƒæ¶ˆæ¯æµ
| Topic | ç”Ÿäº§è€… | æ¶ˆè´¹è€… | æè¿° | æ–‡æ¡£è¦†ç›– |
|-------|--------|--------|------|----------|
| `gochat.messages.upstream` | im-gateway | im-logic | ä¸Šè¡Œæ¶ˆæ¯ | âœ… |
| `gochat.messages.persist` | im-logic | im-task | æŒä¹…åŒ–æ¶ˆæ¯ | âœ… |
| `gochat.messages.downstream.{id}` | im-logic/im-task | im-gateway | ä¸‹è¡Œæ¶ˆæ¯ | âœ… |
| `gochat.tasks.fanout` | im-logic | im-task | æ‰‡å‡ºä»»åŠ¡ | âœ… |

### 4.2 é¢†åŸŸäº‹ä»¶
| Topic | æè¿° | æ–‡æ¡£è¦†ç›– | ä½¿ç”¨çŠ¶æ€ |
|-------|------|----------|----------|
| `gochat.user-events` | ç”¨æˆ·äº‹ä»¶ | âœ… | âœ… |
| `gochat.conversation-events` | ä¼šè¯äº‹ä»¶ | âœ… | âœ… |
| `gochat.message-events` | æ¶ˆæ¯äº‹ä»¶ | âœ… | âœ… |
| `gochat.friend-events` | å¥½å‹äº‹ä»¶ | âœ… | ğŸ“‹ |
| `gochat.system-notifications` | ç³»ç»Ÿé€šçŸ¥ | âœ… | ğŸ“‹ |

## 5. é—æ¼åŠŸèƒ½æ¸…å•

### 5.1 é«˜ä¼˜å…ˆçº§é—æ¼ (éœ€è¦è¡¥å……)
- âŒ **å¥½å‹ç®¡ç†å®Œæ•´å®ç°**: protoå®šä¹‰ã€RPCå®ç°ã€HTTPæ¥å£
- âŒ **ç”¨æˆ·æœç´¢åŠŸèƒ½**: æœç´¢æ¥å£å®ç°å’Œä¼˜åŒ–
- âŒ **Tokenåˆ·æ–°æœºåˆ¶**: è‡ªåŠ¨åˆ·æ–°å’Œé»‘åå•
- âŒ **æ¶ˆæ¯æ’¤å›åŠŸèƒ½**: æ¶ˆæ¯åˆ é™¤å’Œæ’¤å›é€šçŸ¥
- âŒ **è¾“å…¥çŠ¶æ€æŒ‡ç¤º**: typing indicatoråŠŸèƒ½

### 5.2 ä¸­ä¼˜å…ˆçº§é—æ¼ (åç»­è¡¥å……)
- âš ï¸ **ä¼šè¯è®¾ç½®ç®¡ç†**: ç¾¤èŠè®¾ç½®ã€é€šçŸ¥è®¾ç½®
- âš ï¸ **æ–‡ä»¶æ¶ˆæ¯æ”¯æŒ**: å›¾ç‰‡ã€æ–‡ä»¶ä¸Šä¼ ä¸‹è½½
- âš ï¸ **æ¶ˆæ¯æœç´¢åŠŸèƒ½**: å…¨æ–‡æœç´¢å’Œè¿‡æ»¤
- âš ï¸ **ç”¨æˆ·é»‘åå•**: æ‹‰é»‘å’Œå±è”½åŠŸèƒ½

### 5.3 ä½ä¼˜å…ˆçº§åŠŸèƒ½ (é•¿æœŸè§„åˆ’)
- ğŸ“‹ **æ¶ˆæ¯è½¬å‘**: æ¶ˆæ¯è½¬å‘åˆ°å…¶ä»–ä¼šè¯
- ğŸ“‹ **ç¾¤å…¬å‘Šç®¡ç†**: ç¾¤å…¬å‘Šå‘å¸ƒå’Œç®¡ç†
- ğŸ“‹ **ä¼šè¯ç½®é¡¶**: é‡è¦ä¼šè¯ç½®é¡¶æ˜¾ç¤º
- ğŸ“‹ **æ¶ˆæ¯å¼•ç”¨**: å›å¤ç‰¹å®šæ¶ˆæ¯

## 6. æ¥å£ä¸€è‡´æ€§æ£€æŸ¥

### 6.1 æ•°æ®æ¨¡å‹ä¸€è‡´æ€§ âœ…
- ç»Ÿä¸€ä½¿ç”¨ `common/v1/types.proto` ä¸­çš„ç±»å‹å®šä¹‰
- æ¶ˆé™¤äº†ä¸åŒå±‚æ¬¡é—´çš„ç±»å‹ä¸åŒ¹é…é—®é¢˜

### 6.2 é”™è¯¯å¤„ç†ä¸€è‡´æ€§ âœ…
- ç»Ÿä¸€çš„é”™è¯¯ç å®šä¹‰
- æ ‡å‡†åŒ–çš„é”™è¯¯å“åº”æ ¼å¼

### 6.3 åˆ†é¡µæ¥å£ä¸€è‡´æ€§ âœ…
- HTTP API ä½¿ç”¨ page/pageSize åˆ†é¡µ
- gRPC ä½¿ç”¨ offset/limit åˆ†é¡µ
- æ¸¸æ ‡åˆ†é¡µç”¨äºé«˜æ€§èƒ½åœºæ™¯

## 7. æ€»ç»“

**å½“å‰è¦†ç›–æƒ…å†µï¼š**
- âœ… **å®Œæ•´è¦†ç›–**: æ ¸å¿ƒæ¶ˆæ¯æ”¶å‘ã€ä¼šè¯ç®¡ç†ã€ç”¨æˆ·è®¤è¯
- âš ï¸ **éƒ¨åˆ†è¦†ç›–**: å¥½å‹ç®¡ç†ã€ç”¨æˆ·æœç´¢ã€æ¶ˆæ¯å¢å¼ºåŠŸèƒ½  
- âŒ **ç¼ºå¤±åŠŸèƒ½**: è¾“å…¥çŠ¶æ€ã€æ–‡ä»¶æ¶ˆæ¯ã€æ¶ˆæ¯æœç´¢

**ä¸‹ä¸€æ­¥å·¥ä½œï¼š**
1. è¡¥å……å¥½å‹ç®¡ç†çš„å®Œæ•´ proto å®šä¹‰å’Œå®ç°
2. å®ç°ç”¨æˆ·æœç´¢å’Œèµ„æ–™ç®¡ç†åŠŸèƒ½
3. æ·»åŠ æ¶ˆæ¯æ’¤å›å’Œè¾“å…¥çŠ¶æ€åŠŸèƒ½
4. å®Œå–„é”™è¯¯å¤„ç†å’Œç›‘æ§æŒ‡æ ‡

é€šè¿‡è¿™ä¸ªæ¸…å•å¯ä»¥ç¡®ä¿ GoChat ç³»ç»ŸåŠŸèƒ½çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚