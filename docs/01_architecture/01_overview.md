# GoChat 架构概览

本文档提供了 GoChat 系统架构的高级概览，包括其组件以及它们之间的数据流。

## 1. 系统目标

GoChat 的主要目标是提供可靠、可扩展和低延迟的即时通讯服务。它支持核心功能，如用户注册、实时一对一聊天、群聊、消息历史记录和通知。该项目是面向就业的学习项目，侧重于分布式微服务架构与 Go 语言实践，以及良好的代码质量和测试覆盖率。不要扩展太多内容，保持简洁，遵循 KISS 原则。

## 2. 微服务架构

系统采用微服务架构设计，以确保关注点分离、独立可扩展性和可维护性。核心服务包括：

-   **`im-gateway`**: API 网关是所有客户端（Web、移动端）的唯一入口点。它处理客户端连接（HTTP/WebSocket），转换协议，并将请求路由到适当的后端服务。它负责管理持久化的 WebSocket 连接以实现实时通信。

-   **`im-logic`**: 此服务包含应用程序的核心业务逻辑。其职责包括用户认证（登录、注册、访客访问）、会话管理、会话和群组逻辑，以及通过从其他服务获取数据来组成响应。它是大多数面向用户操作的中央协调器。

-   **`im-repo`**: 仓储服务负责所有数据持久化。它抽象了数据库和缓存层，为其他服务提供清晰的 gRPC API 来访问和操作数据。它直接与 MySQL 交互以进行持久化存储，与 Redis 交互以进行缓存和管理瞬时数据（如在线状态）。

-   **`im-task`**: 任务服务处理所有异步后台处理。其主要角色是消费来自消息队列（Kafka）的消息，并执行不需要同步处理的任务，例如群聊中的消息扩散到多个收件人或推送通知。这解耦了核心消息流，并提高了系统的弹性和性能。

## 3. 数据流：发送消息

下图说明了用户发送消息时的数据流：

```
[Client] --(WebSocket)--> [im-gateway] --(gRPC)--> [im-logic]
    ^                                                   |
    |                                                   v
    |                                             [im-repo (DB/Cache)]
    |                                                   |
    |                                                   v
    +------------------ [im-task] <--(Kafka)-- [im-logic]
            (WebSocket)      ^
                             | (gRPC)
                             |
                       [im-repo (Cache)]
```

**步骤：**

1.  **客户端到网关**: 用户通过持久的 WebSocket 连接向 `im-gateway` 发送消息。
2.  **网关到逻辑**: `im-gateway` 接收消息并通过 gRPC 调用将其转发到 `im-logic` 进行处理。
3.  **逻辑到仓储（保存）**: `im-logic` 执行验证，从 `im-repo` 请求持久化序列 ID，然后将消息发送到 `im-repo` 以保存在 MySQL 数据库中。
4.  **逻辑到消息队列**: 消息保存后，`im-logic` 将"消息分发"事件发布到 Kafka 主题。
5.  **任务消费事件**: `im-task` 订阅了 Kafka 主题并消费分发事件。
6.  **任务到仓储（查询）**: `im-task` 确定消息的所有接收者。它查询 `im-repo` 以获取每个接收者的在线状态，其中包括他们连接到的特定 `im-gateway` 实例。
7.  **任务到网关（推送）**: `im-task` 将消息推送到适当的 `im-gateway` 实例，以便每个在线接收者接收。
8.  **网关到客户端**: `im-gateway` 实例通过它们各自的 WebSocket 连接将消息传递给在线接收者。
