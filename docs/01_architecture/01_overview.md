# GoChat 架构概览

本文档提供了 GoChat 系统架构的高级概览，包括其组件以及它们之间的数据流。

## 1. 系统目标

GoChat 的主要目标是提供可靠、可扩展和低延迟的即时通讯服务。它支持核心功能，如用户注册、实时一对一聊天、群聊、消息历史记录和通知。该项目是面向就业的学习项目，侧重于分布式微服务架构与 Go 语言实践，以及良好的代码质量和测试覆盖率。不要扩展太多内容，保持简洁，遵循 KISS 原则。

## 2. 微服务架构

系统采用微服务架构设计，以确保关注点分离、独立可扩展性和可维护性。核心服务包括：

-   **`im-gateway`**: API 网关是所有客户端（Web、移动端）的唯一入口点。它处理客户端连接（HTTP/WebSocket），转换协议，并将请求路由到适当的后端服务。它负责管理持久化的 WebSocket 连接以实现实时通信。

-   **`im-logic`**: 此服务包含应用程序的核心业务逻辑。其职责包括用户认证（登录、注册、访客访问）、会话管理、会话和群组逻辑，以及通过从其他服务获取数据来组成响应。它是大多数面向用户操作的中央协调器。

-   **`im-repo`**: 仓储服务负责所有数据持久化。它抽象了数据库和缓存层，为其他服务提供清晰的 gRPC API 来访问和操作数据。它直接与 MySQL 交互以进行持久化存储，与 Redis 交互以进行缓存和管理瞬时数据（如在线状态）。

-   **`im-task`**: 任务服务处理所有异步后台处理。其主要角色是消费来自消息队列（Kafka）的消息，并执行不需要同步处理的任务，例如群聊中的消息扩散到多个收件人或推送通知。这解耦了核心消息流，并提高了系统的弹性和性能。

## 3. 数据流：发送消息

GoChat 系统的消息流遵循一个核心原则：**持久化先行，推送解耦**。

1.  **上行**: 客户端通过 WebSocket 向 `im-gateway` 发送消息。`im-gateway` 将其生产到 `gochat.messages.upstream` 主题。
2.  **核心处理**: `im-logic` 消费上行消息，执行核心业务逻辑（如权限检查、生成 message_id 等）。
3.  **持久化**: `im-logic` **立即**将处理后的消息生产到 `gochat.messages.persist` 主题。`im-task` 服务会消费此主题，并调用 `im-repo` 完成**唯一的一次**数据持久化。
4.  **推送**: 在生产持久化消息的**同时**，`im-logic` 会根据场景执行不同的推送策略：
    -   **单聊/中小群**: 直接查询在线状态，并将消息生产到目标 `im-gateway` 的专属主题 `gochat.messages.downstream.{instanceID}`。
    -   **超大群**: 将一个轻量级的扇出任务生产到 `gochat.tasks.fanout` 主题，由 `im-task` 异步完成后续的扩散推送。

这种设计确保了无论后续的推送逻辑（单聊、中小群、超大群）如何，消息的持久化总是优先、可靠地发生，且只发生一次。
