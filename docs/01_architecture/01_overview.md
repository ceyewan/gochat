# GoChat 架构概览

本文档提供了 GoChat 系统架构的高级概览，包括其组件以及它们之间的数据流。

## 1. 系统目标

GoChat 的主要目标是提供可靠、可扩展和低延迟的即时通讯服务。它支持核心功能，如用户注册、实时一对一聊天、群聊、消息历史记录和通知。该项目是面向就业的学习项目，侧重于分布式微服务架构与 Go 语言实践，以及良好的代码质量和测试覆盖率。不要扩展太多内容，保持简洁，遵循 KISS 原则。

## 2. 微服务架构

系统采用微服务架构设计，以确保关注点分离、独立可扩展性和可维护性。核心服务包括：

-   **`im-gateway`**: API 网关是所有客户端（Web、移动端）的唯一入口点。它处理客户端连接（HTTP/WebSocket），转换协议，并将请求路由到适当的后端服务。它负责管理持久化的 WebSocket 连接以实现实时通信。

-   **`im-logic`**: 此服务包含应用程序的核心业务逻辑。其职责包括用户认证（登录、注册、访客访问）、会话管理、会话和群组逻辑，以及通过从其他服务获取数据来组成响应。它是大多数面向用户操作的中央协调器。

-   **`im-repo`**: 仓储服务负责所有数据持久化。它抽象了数据库和缓存层，为其他服务提供清晰的 gRPC API 来访问和操作数据。它直接与 MySQL 交互以进行持久化存储，与 Redis 交互以进行缓存和管理瞬时数据（如在线状态）。

-   **`im-task`**: 任务服务处理所有异步后台处理。其主要角色是消费来自消息队列（Kafka）的消息，并执行不需要同步处理的任务，例如群聊中的消息扩散到多个收件人或推送通知。这解耦了核心消息流，并提高了系统的弹性和性能。

## 3. 数据流：发送消息

GoChat 系统的消息流在 `im-logic` 处理后，被清晰地分离为**持久化流**和**推送流**，二者并行处理，互不阻塞。

### 3.1 上行与核心处理

1.  **上行**: 客户端通过 WebSocket 向 `im-gateway` 发送消息。`im-gateway` 将其生产到 `gochat.messages.upstream` 主题。
2.  **核心处理**: `im-logic` 消费上行消息，执行核心业务逻辑（如权限检查、生成 message_id 等）。处理完成后，进入并行的持久化与推送阶段。

### 3.2 持久化流 (Persistence Flow)

1.  **生产**: `im-logic` 将完整的消息体生产到 `gochat.messages.persist` 主题。**每条原始消息只生产一次**。
2.  **消费与持久化**: `im-task` 服务作为唯一的消费者，订阅 `gochat.messages.persist` 主题，收到消息后调用 `im-repo` 将其写入数据库。这保证了每条消息只被持久化一次。

### 3.3 推送流 (Push Flow)

推送流根据群聊规模采用不同策略：

#### a) 单聊与中小群

1.  **生产**: `im-logic` 在发送持久化消息的同时，查询接收者/群成员的在线状态，并将消息生产到每个在线用户所在的 `im-gateway` 实例的专属主题 `gochat.messages.downstream.{instanceID}`。
2.  **消费与推送**: 各 `im-gateway` 实例消费自己的专属主题，并将消息通过 WebSocket 推送给客户端。

#### b) 超大群

1.  **任务分发**: `im-logic` 在发送持久化消息的同时，向 `gochat.tasks.fanout` 主题生产一个轻量级的扇出任务。
2.  **异步扇出**: `im-task` 消费扇出任务，获取群成员列表，然后执行与中小群类似的逻辑，将消息生产到各个 `im-gateway` 的专属主题中。

这种**持久化与推送分离**的设计，是系统可靠性的关键。即使推送逻辑（特别是超大群扇出）出现延迟或失败，也绝不会影响核心消息的持久化。
