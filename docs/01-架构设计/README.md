# 架构设计文档

## 整体架构

GoChat 采用微服务架构，将系统拆分为多个独立的服务，每个服务负责特定的功能。

## 架构图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   im-gateway    │    │    im-logic     │    │    im-repo      │    │    im-task      │
│                 │    │                 │    │                 │    │                 │
│  ┌───────────┐  │    │  ┌───────────┐  │    │  ┌───────────┐  │    │  ┌───────────┐  │
│  │ WebSocket │  │    │  │ gRPC     │  │    │  │ gRPC     │  │    │  │ Kafka    │  │
│  │ Server    │  │    │  │ Server   │  │    │  │ Server   │  │    │  │ Consumer │  │
│  └───────────┘  │    │  └───────────┘  │    │  └───────────┘  │    │  └───────────┘  │
│  ┌───────────┐  │    │  ┌───────────┐  │    │  ┌───────────┐  │    │  ┌───────────┐  │
│  │ HTTP      │  │    │  │ Kafka    │  │    │  │ MySQL     │  │    │  │ gRPC     │  │
│  │ Server    │  │    │  │ Producer │  │    │  │ Database  │  │    │  │ Client   │  │
│  └───────────┘  │    │  └───────────┘  │    │  └───────────┘  │    │  └───────────┘  │
│  ┌───────────┐  │    │  ┌───────────┐  │    │  ┌───────────┐  │    │  ┌───────────┐  │
│  │ Kafka    │  │    │  │ Kafka    │  │    │  │ Redis     │  │    │  │ Kafka    │  │
│  │ Consumer │  │    │  │ Consumer │  │    │  │ Cache     │  │    │  │ Producer │  │
│  └───────────┘  │    │  └───────────┘  │    │  └───────────┘  │    │  └───────────┘  │
└─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘
       │                       │                       │                       │
       └───────────────────────┼───────────────────────┼───────────────────────┘
                               │                       │
                               └───────────────────────┘
```

## 服务划分

### 1. im-gateway (网关服务)

**职责**:
- 处理客户端 WebSocket 连接
- 处理 HTTP API 请求
- 消息路由和转发
- 客户端会话管理

**技术特性**:
- 基于 Gin 的 HTTP 服务器
- 基于 gorilla/websocket 的 WebSocket 服务器
- Kafka 消息队列
- 客户端连接管理

**端口**:
- HTTP: 8080
- 内部管理: 8081

### 2. im-logic (逻辑服务)

**职责**:
- 用户认证和授权
- 消息业务逻辑处理
- 会话管理
- 群组管理
- 消息路由决策

**技术特性**:
- gRPC 服务器
- Kafka 消息队列
- 业务逻辑处理
- 缓存管理

**端口**:
- gRPC: 9001

### 3. im-repo (数据服务)

**职责**:
- 数据持久化
- 数据查询和检索
- 事务管理
- 数据一致性保证

**技术特性**:
- gRPC 服务器
- MySQL 数据库
- Redis 缓存
- 数据访问层

**端口**:
- gRPC: 9002

### 4. im-task (任务服务)

**职责**:
- 大群消息扇出
- 消息持久化
- 离线推送
- 异步任务处理

**技术特性**:
- Kafka 消费者
- gRPC 客户端
- 任务调度
- 批量处理

**端口**:
- 无对外端口

## 数据存储

### MySQL

**用途**:
- 用户数据
- 消息数据
- 会话数据
- 群组数据

**数据库设计**:
- 用户表 (users)
- 消息表 (messages)
- 会话表 (conversations)
- 群组表 (groups)
- 群组成员表 (group_members)

### Redis

**用途**:
- 会话缓存
- 用户在线状态
- 消息队列
- 频繁访问数据缓存

**缓存策略**:
- 用户会话: 30分钟过期
- 用户在线状态: 5分钟过期
- 消息队列: 持久化存储

## 消息队列

### Kafka Topics

1. **im-upstream-topic**: 上游消息，客户端发送的消息
2. **im-downstream-topic-{gateway_id}**: 下游消息，发送到特定网关
3. **im-task-topic**: 任务消息，异步处理任务

### 消息路由

```
Client → im-gateway → im-upstream-topic → im-logic → im-downstream-topic-{gateway_id} → im-gateway → Client
                                        ↓
                                        im-task-topic → im-task → 持久化/推送
```

## 服务发现

### etcd

**用途**:
- 服务注册和发现
- 配置管理
- 健康检查

**服务注册**:
- 每个服务启动时注册到 etcd
- 定期发送心跳保持活性
- 服务下线时自动注销

## 通信模式

### 同步通信

- **gRPC**: 服务间同步调用
- **HTTP**: 客户端 API 调用

### 异步通信

- **Kafka**: 服务间消息传递
- **WebSocket**: 客户端实时通信

## 扩展性设计

### 水平扩展

- **im-gateway**: 支持多实例，通过负载均衡分发
- **im-logic**: 支持多实例，通过 Kafka 分区处理
- **im-repo**: 支持读写分离和分库分表
- **im-task**: 支持多实例消费者组

### 负载均衡

- **客户端**: 通过 DNS 或负载均衡器
- **服务间**: 通过服务发现和负载均衡

## 可用性设计

### 故障转移

- 服务实例故障时自动转移
- 数据库主从切换
- 消息队列副本机制

### 降级策略

- 核心功能优先保证
- 非核心功能可降级
- 缓存降级机制

## 安全设计

### 认证授权

- JWT Token 认证
- RBAC 权限控制
- API 签名验证

### 数据安全

- 数据库连接加密
- API 通信加密
- 敏感数据脱敏

## 监控和日志

### 监控指标

- 服务健康状态
- 性能指标 (QPS, 响应时间)
- 资源使用率
- 错误率

### 日志管理

- 结构化日志
- 日志分级
- 日志聚合和分析
- 链路追踪

## 部署架构

### 容器化

- Docker 容器化部署
- Docker Compose 编排
- Kubernetes 支持 (可选)

### 配置管理

- 环境变量配置
- 配置文件管理
- 动态配置更新