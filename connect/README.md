# GoChat WebSocket API 文档

本文档描述了 GoChat 应用程序的 WebSocket API，包括连接流程、消息格式和心跳机制。

## 连接端点

```
ws://localhost:8081/ws
```

## 连接流程

1. 客户端建立到端点的 WebSocket 连接
2. 客户端发送连接请求消息
3. 服务器验证连接并返回成功或失败
4. 连接成功后，客户端必须保持心跳通信

## 消息格式

### 连接请求（客户端 → 服务器）

```json
{
  "user_id": 123,       // 整数：用户 ID
  "room_id": 456,       // 整数：房间 ID
  "token": "认证令牌",   // 字符串：认证令牌
  "msg_type": "connect" // 字符串：必须为 "connect"
}
```

### 连接响应（服务器 → 客户端）

**成功：**

```json
{
  "msg_type": "success",
  "data": null
}
```

**失败：**

```json
{
  "msg_type": "fail",
  "data": null
}
```

### 聊天消息（服务器 → 客户端）

```json
{
  "msg_type": "pushmsg",
  "data": {
    "from_user_id": 123,       // 整数：发送者用户 ID
    "to_user_id": 456,         // 整数：接收者用户 ID
    "from_user_name": "Alice", // 字符串：发送者用户名
    "to_user_name": "Bob",     // 字符串：接收者用户名
    "room_id": 789,            // 整数：房间 ID
    "message": "你好！",       // 字符串：消息内容
    "create_time": "2025-03-10T12:00:00Z", // 字符串：创建时间戳
    "message_id": 12345        // 整数：唯一消息 ID
  }
}
```

### 房间信息（服务器 → 客户端）

```json
{
  "msg_type": "roominfo",
  "data": {
    "room_id": 789,           // 整数：房间 ID
    "count": 5,               // 整数：房间中的用户数量
    "user_info": {            // 映射：用户信息
      "123": "Alice",        // 键：用户 ID，值：用户名
      "456": "Bob"
    }
  }
}
```

## 心跳机制

为了保持连接活跃，实现了心跳机制：

- **间隔**：服务器每 30 秒发送一次 ping 消息
- **超时**：如果 60 秒内没有检测到活动，连接将被关闭

### 心跳消息

**Ping**（服务器 → 客户端）

```json
{
  "type": "ping"
}
```

**Pong**（客户端 → 服务器）

```json
{
  "type": "pong"
}
```

## 断开连接

连接可以通过以下方式终止：

- 客户端关闭 WebSocket 连接
- 服务器检测到心跳超时（60 秒无活动）
- 认证失败

断开连接时，服务器将：

1. 从连接管理器中移除用户
2. 通过 RPC 通知逻辑服务断开连接
3. 关闭 WebSocket 连接

## 错误处理

- 如果消息无法解析，将被忽略
- 如果心跳超时，连接将被关闭
- 如果认证失败，连接将关闭并返回失败消息
